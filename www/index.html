<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro MQTT Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
      :root {
        --bg: #f4f7f6;
        --card-bg: #ffffff;
        --primary: #007bff;
        --success: #28a745;
        --text: #333;
        --edit-bg: #fff9db;
      }

      body {
        font-family: "Segoe UI", Tahoma, sans-serif;
        background: var(--bg);
        margin: 0;
        color: var(--text);
      }
      nav {
        background: #24292e;
        padding: 10px;
        display: flex;
        gap: 15px;
        justify-content: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      nav a {
        color: #fafbfc;
        text-decoration: none;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
      }
      nav a.active {
        background: var(--primary);
      }

      .container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 15px;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      .controls-bar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
      }
      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
      }
      .btn-edit {
        background: #ff9f43;
        color: white;
      }
      .btn-edit.active {
        background: var(--success);
      }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 15px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        display: flex;
        flex-direction: column;
        position: relative;
        min-height: 140px;
      }
      .edit-mode .card {
        background: var(--edit-bg);
        outline: 2px dashed #f1c40f;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }
      .card-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
      }
      .card-icon {
        font-size: 1.4rem;
      }

      .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .card-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
      }
      .card-unit {
        font-size: 0.9rem;
        color: #999;
        margin-top: 2px;
      }

      /* Switch UI */
      .switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--success);
      }
      input:checked + .slider:before {
        transform: translateX(22px);
      }

      /* Gauge UI */
      .gauge-wrap {
        position: relative;
        width: 100px;
        height: 50px;
        overflow: hidden;
      }
      .gauge-bg {
        width: 100px;
        height: 100px;
        border: 10px solid #eee;
        border-radius: 50%;
        box-sizing: border-box;
      }
      .gauge-fill {
        position: absolute;
        top: 0;
        left: 0;
        width: 100px;
        height: 100px;
        border: 10px solid var(--primary);
        border-bottom-color: transparent;
        border-left-color: transparent;
        border-radius: 50%;
        box-sizing: border-box;
        transform: rotate(-45deg);
        transition: 0.5s;
      }

      /* Editor Overlays */
      .edit-fields {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 10;
        padding: 10px;
        border-radius: 12px;
        box-sizing: border-box;
        flex-direction: column;
        gap: 4px;
        overflow-y: auto;
      }
      .edit-mode .edit-fields {
        display: flex;
      }
      .edit-fields input,
      .edit-fields select {
        padding: 4px;
        font-size: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .settings-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 600px;
        margin: 0 auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .form-item {
        margin-bottom: 15px;
      }
      .form-item label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 0.9rem;
      }
      .form-item input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }

      pre {
        background: #1e1e1e;
        color: #a9dc76;
        padding: 15px;
        border-radius: 8px;
        overflow: auto;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <nav>
      <a onclick="showP('dash')" id="nav-dash" class="active">Dashboard</a>
      <a onclick="showP('mqtt')" id="nav-mqtt">MQTT Settings</a>
      <a onclick="showP('raw')" id="nav-raw">Raw Data</a>
    </nav>

    <div class="container">
      <div id="p-dash" class="page active">
        <div class="controls-bar">
          <button class="btn btn-edit" id="btn-edit" onclick="toggleEdit()">
            ‚úé –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
          </button>
        </div>
        <div id="dashboard" class="dashboard-grid"></div>
      </div>

      <div id="p-mqtt" class="page">
        <div class="settings-card">
          <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë—Ä–æ–∫–µ—Ä—É</h2>
          <div class="form-item">
            <label>URL (wss://...)</label><input type="text" id="mq_url" />
          </div>
          <div class="form-item">
            <label>Username</label><input type="text" id="mq_user" />
          </div>
          <div class="form-item">
            <label>Password</label><input type="password" id="mq_pass" />
          </div>
          <div class="form-item">
            <label>Main Topic</label
            ><input type="text" id="mq_topic" value="#" />
          </div>
          <button
            class="btn"
            style="background: var(--primary); color: white; width: 100%"
            onclick="saveMqtt()"
          >
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
          </button>
        </div>
      </div>

      <div id="p-raw" class="page">
        <pre id="raw-stream">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</pre>
      </div>
    </div>

    <script>
      const CONFIG_KEY = "mqtt-dashboard-config";
      let client = null;
      let isEdit = false;

      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ –í–°–ï–ú–ò –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ JSON
      function getInitialConfig() {
        const params = {
          bme_t: {
            name: "BME Temp",
            jsonKey: "/bme-t",
            type: "number",
            unit: "¬∞C",
            icon: "üå°Ô∏è",
          },
          bme_h: {
            name: "BME Hum",
            jsonKey: "/bme-h",
            type: "gauge",
            unit: "%",
            icon: "üíß",
          },
          bme_p: {
            name: "BME Press",
            jsonKey: "/bme-p",
            type: "number",
            unit: "Pa",
            icon: "‚è≤Ô∏è",
          },
          dht_t: {
            name: "DHT Temp",
            jsonKey: "/dht-t",
            type: "number",
            unit: "¬∞C",
            icon: "üå°Ô∏è",
          },
          dht_h: {
            name: "DHT Hum",
            jsonKey: "/dht-h",
            type: "number",
            unit: "%",
            icon: "üíß",
          },
          t1: {
            name: "Sensor T1",
            jsonKey: "/t1",
            type: "number",
            unit: "¬∞C",
            icon: "üìç",
          },
          t2: {
            name: "Sensor T2",
            jsonKey: "/t2",
            type: "number",
            unit: "¬∞C",
            icon: "üìç",
          },
          t3: {
            name: "Sensor T3",
            jsonKey: "/t3",
            type: "number",
            unit: "¬∞C",
            icon: "üìç",
          },
          t4: {
            name: "Sensor T4",
            jsonKey: "/t4",
            type: "number",
            unit: "¬∞C",
            icon: "üìç",
          },
          r0: {
            name: "–†–µ–ª–µ 0",
            jsonKey: "/r0",
            type: "switch",
            unit: "",
            icon: "üîå",
            controlTopic: "cmnd/relay0",
          },
          r1: {
            name: "–†–µ–ª–µ 1",
            jsonKey: "/r1",
            type: "switch",
            unit: "",
            icon: "üîå",
            controlTopic: "cmnd/relay1",
          },
          r2: {
            name: "–†–µ–ª–µ 2",
            jsonKey: "/r2",
            type: "switch",
            unit: "",
            icon: "üîå",
            controlTopic: "cmnd/relay2",
          },
          r3: {
            name: "–†–µ–ª–µ 3",
            jsonKey: "/r3",
            type: "switch",
            unit: "",
            icon: "üîå",
            controlTopic: "cmnd/relay3",
          },
          uptime: {
            name: "Uptime",
            jsonKey: "uptime",
            type: "text",
            unit: "s",
            icon: "‚è±Ô∏è",
          },
        };

        return {
          mqtt: { url: "", username: "", password: "", topic: "#" },
          parameters: params,
          dashboard: {
            layout: Object.keys(params).map((k) => ({
              id: "c_" + k,
              parameter: k,
            })),
          },
        };
      }

      function getConfig() {
        const stored = localStorage.getItem(CONFIG_KEY);
        return stored ? JSON.parse(stored) : getInitialConfig();
      }

      function saveConfig(cfg) {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      }

      // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Dashboard
      function render() {
        const cfg = getConfig();
        const grid = document.getElementById("dashboard");
        grid.innerHTML = "";
        grid.className = isEdit ? "dashboard-grid edit-mode" : "dashboard-grid";

        cfg.dashboard.layout.forEach((item) => {
          const p = cfg.parameters[item.parameter];
          if (!p) return;

          const card = document.createElement("div");
          card.className = "card";

          let bodyHtml = "";
          switch (p.type) {
            case "switch":
              bodyHtml = `<label class="switch"><input type="checkbox" id="v-${p.jsonKey}" onchange="sendCmd('${item.parameter}', this.checked)"><span class="slider"></span></label>`;
              break;
            case "gauge":
              bodyHtml = `<div class="gauge-wrap"><div class="gauge-bg"></div><div class="gauge-fill" id="g-${p.jsonKey}"></div><div style="position:absolute; bottom:0; width:100%; text-align:center; font-weight:bold" id="v-${p.jsonKey}">--</div></div>`;
              break;
            default:
              bodyHtml = `<span class="card-value" id="v-${p.jsonKey}">--</span><span class="card-unit">${p.unit}</span>`;
          }

          card.innerHTML = `
                <div class="card-header"><span class="card-title">${
                  p.name
                }</span><span class="card-icon">${p.icon}</span></div>
                <div class="card-body">${bodyHtml}</div>
                <div class="edit-fields">
                    <input type="text" value="${p.name}" onchange="updP('${
            item.parameter
          }','name',this.value)" placeholder="–ò–º—è">
                    <input type="text" value="${p.icon}" onchange="updP('${
            item.parameter
          }','icon',this.value)" placeholder="–ò–∫–æ–Ω–∫–∞">
                    <input type="text" value="${p.unit}" onchange="updP('${
            item.parameter
          }','unit',this.value)" placeholder="–ï–¥. –∏–∑–º.">
                    <select onchange="updP('${
                      item.parameter
                    }','type',this.value)">
                        <option value="number" ${
                          p.type == "number" ? "selected" : ""
                        }>Number</option>
                        <option value="switch" ${
                          p.type == "switch" ? "selected" : ""
                        }>Switch</option>
                        <option value="gauge" ${
                          p.type == "gauge" ? "selected" : ""
                        }>Gauge</option>
                        <option value="text" ${
                          p.type == "text" ? "selected" : ""
                        }>Text</option>
                    </select>
                    ${
                      p.type === "switch"
                        ? `<input type="text" value="${
                            p.controlTopic || ""
                          }" onchange="updP('${
                            item.parameter
                          }','controlTopic',this.value)" placeholder="Control Topic">`
                        : ""
                    }
                </div>
            `;
          grid.appendChild(card);
        });
      }

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      function sendCmd(pId, state) {
        const cfg = getConfig();
        const p = cfg.parameters[pId];
        if (client && p.controlTopic) {
          const message = new Paho.MQTT.Message(state ? "1" : "0");
          message.destinationName = p.controlTopic;
          client.send(message);
        }
      }

      function updP(pId, field, val) {
        const cfg = getConfig();
        cfg.parameters[pId][field] = val;
        saveConfig(cfg);
        render();
      }

      function toggleEdit() {
        isEdit = !isEdit;
        const btn = document.getElementById("btn-edit");
        btn.innerText = isEdit
          ? "‚úî –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
          : "‚úé –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏";
        btn.classList.toggle("active");
        render();
      }

      // MQTT
      function connect() {
        const cfg = getConfig();
        if (!cfg.mqtt.url) return;

        const urlParts = cfg.mqtt.url.replace("wss://", "").split(":");
        client = new Paho.MQTT.Client(
          urlParts[0],
          parseInt(urlParts[1]) || 8884,
          "cl-" + Math.random().toString(16).slice(2, 6)
        );

        client.onMessageArrived = (msg) => {
          const data = JSON.parse(msg.payloadString);
          document.getElementById("raw-stream").innerText = JSON.stringify(
            data,
            null,
            4
          );

          Object.values(cfg.parameters).forEach((p) => {
            const val = data[p.jsonKey];
            if (val === undefined) return;
            const el = document.getElementById(`v-${p.jsonKey}`);
            if (!el) return;

            if (p.type === "switch") {
              el.checked = val > 0 || val === true;
            } else if (p.type === "gauge") {
              el.innerText = val;
              const g = document.getElementById(`g-${p.jsonKey}`);
              if (g) g.style.transform = `rotate(${(val / 100) * 180 - 45}deg)`;
            } else {
              el.innerText = val;
            }
          });
        };

        client.connect({
          useSSL: true,
          userName: cfg.mqtt.username,
          password: cfg.mqtt.password,
          onSuccess: () => client.subscribe(cfg.mqtt.topic),
          onFailure: (e) => console.error(e),
        });
      }

      function saveMqtt() {
        const cfg = getConfig();
        cfg.mqtt.url = document.getElementById("mq_url").value;
        cfg.mqtt.username = document.getElementById("mq_user").value;
        cfg.mqtt.password = document.getElementById("mq_pass").value;
        cfg.mqtt.topic = document.getElementById("mq_topic").value;
        saveConfig(cfg);
        connect();
        showP("dash");
      }

      function showP(id) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll("nav a")
          .forEach((a) => a.classList.remove("active"));
        document.getElementById("p-" + id).classList.add("active");
        document.getElementById("nav-" + id).classList.add("active");
      }

      window.onload = () => {
        const cfg = getConfig();
        document.getElementById("mq_url").value = cfg.mqtt.url;
        document.getElementById("mq_user").value = cfg.mqtt.username;
        document.getElementById("mq_pass").value = cfg.mqtt.password;
        render();
        if (cfg.mqtt.url) connect();
      };
    </script>
  </body>
</html>
