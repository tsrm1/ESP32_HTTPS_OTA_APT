<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MQTT IoT Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
      :root {
        --primary: #007bff;
        --success: #28a745;
        --bg: #f4f7f9;
        --card: #ffffff;
        --text: #2c3e50;
      }

      body {
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg);
        margin: 0;
        color: var(--text);
      }

      nav {
        background: #1a252f;
        padding: 1rem;
        display: flex;
        gap: 15px;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      nav a {
        color: #bdc3c7;
        text-decoration: none;
        font-weight: 600;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }

      nav a:hover {
        color: white;
      }
      nav a.active {
        background: var(--primary);
        color: white;
      }

      .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 20px;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      .card {
        background: var(--card);
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
      }

      h2 {
        margin-top: 0;
        font-size: 1.2rem;
        color: #555;
        border-left: 4px solid var(--primary);
        padding-left: 10px;
      }

      /* Форма настроек */
      .form-group {
        margin-bottom: 1.2rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1rem;
      }

      /* Сетки карточек */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 1.2rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        transition: transform 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-3px);
      }
      .stat-card h3 {
        margin: 0;
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .stat-card p {
        margin: 10px 0 0;
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--primary);
      }

      /* Слайдер реле */
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        margin-top: 15px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--success);
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }

      /* Статус подключения */
      .status-msg {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        font-size: 0.9rem;
      }
      .online {
        background: #d4edda;
        color: #155724;
      }
      .offline {
        background: #f8d7da;
        color: #721c24;
      }

      pre {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <nav>
      <a onclick="showPage('mqtt-settings')" id="nav-mqtt">MQTT</a>
      <a onclick="showPage('dashboard')" id="nav-dash">Dashboard</a>
      <a onclick="showPage('row-data')" id="nav-raw">ROW DATA</a>
    </nav>

    <div class="container">
      <div id="mqtt-settings" class="page active">
        <div class="card">
          <h2>Настройки HiveMQ Cloud</h2>
          <div class="form-group">
            <label>URL брокера (wss://...)</label>
            <input
              type="text"
              id="m_url"
              placeholder="wss://your-id.hivemq.cloud:8884/mqtt"
            />
          </div>
          <div class="form-group">
            <label>Порт</label>
            <input type="number" id="m_port" value="8884" />
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="m_user" />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="m_pass" />
          </div>
          <div class="form-group">
            <label>Топик (Topic)</label>
            <input type="text" id="m_topic" value="#" />
          </div>
          <button
            onclick="saveAndConnect()"
            style="
              background: var(--primary);
              color: white;
              border: none;
              padding: 14px;
              width: 100%;
              border-radius: 6px;
              cursor: pointer;
              font-size: 1rem;
              font-weight: bold;
            "
          >
            Save Settings & Connect
          </button>
        </div>
      </div>

      <div id="dashboard" class="page">
        <div id="conn-status" class="status-msg offline">Disconnected</div>

        <h2>Датчики BME & DHT</h2>
        <div class="grid">
          <div class="stat-card">
            <h3>BME Temp</h3>
            <p id="v-bme-t">--</p>
          </div>
          <div class="stat-card">
            <h3>BME Hum</h3>
            <p id="v-bme-h">--</p>
          </div>
          <div class="stat-card">
            <h3>BME Pressure</h3>
            <p id="v-bme-p">--</p>
          </div>
          <div class="stat-card">
            <h3>DHT Temp</h3>
            <p id="v-dht-t">--</p>
          </div>
          <div class="stat-card">
            <h3>DHT Hum</h3>
            <p id="v-dht-h">--</p>
          </div>
        </div>

        <h2>Датчики DS18B20</h2>
        <div class="grid">
          <div class="stat-card">
            <h3>DS Sensor 1</h3>
            <p id="v-ds-0">--</p>
          </div>
          <div class="stat-card">
            <h3>DS Sensor 2</h3>
            <p id="v-ds-1">--</p>
          </div>
          <div class="stat-card">
            <h3>DS Sensor 3</h3>
            <p id="v-ds-2">--</p>
          </div>
          <div class="stat-card">
            <h3>DS Sensor 4</h3>
            <p id="v-ds-3">--</p>
          </div>
        </div>

        <h2>Управление реле</h2>
        <div class="grid">
          <div class="stat-card">
            <h3>Реле 1</h3>
            <label class="switch"
              ><input type="checkbox" id="v-r-0" disabled /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="stat-card">
            <h3>Реле 2</h3>
            <label class="switch"
              ><input type="checkbox" id="v-r-1" disabled /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="stat-card">
            <h3>Реле 3</h3>
            <label class="switch"
              ><input type="checkbox" id="v-r-2" disabled /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="stat-card">
            <h3>Реле 4</h3>
            <label class="switch"
              ><input type="checkbox" id="v-r-3" disabled /><span
                class="slider"
              ></span
            ></label>
          </div>
        </div>
      </div>

      <div id="row-data" class="page">
        <div class="card">
          <h2>Raw JSON Stream</h2>
          <pre id="raw-output">Ожидание данных...</pre>
        </div>
      </div>
    </div>

    <script>
      let mqttClient = null;

      // 1. Навигация
      function showPage(id) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll("nav a")
          .forEach((a) => a.classList.remove("active"));
        document.getElementById(id).classList.add("active");

        const map = {
          "mqtt-settings": "nav-mqtt",
          dashboard: "nav-dash",
          "row-data": "nav-raw",
        };
        document.getElementById(map[id]).classList.add("active");
      }

      // 2. LocalStorage: Сохранение и Загрузка
      function saveAndConnect() {
        const config = {
          url: document.getElementById("m_url").value,
          port: document.getElementById("m_port").value,
          user: document.getElementById("m_user").value,
          pass: document.getElementById("m_pass").value,
          topic: document.getElementById("m_topic").value,
        };
        localStorage.setItem("mqtt_config_v2", JSON.stringify(config));
        connect();
      }

      function initSettings() {
        const saved = localStorage.getItem("mqtt_config_v2");
        if (saved) {
          const c = JSON.parse(saved);
          document.getElementById("m_url").value = c.url || "";
          document.getElementById("m_port").value = c.port || 8884;
          document.getElementById("m_user").value = c.user || "";
          document.getElementById("m_pass").value = c.pass || "";
          document.getElementById("m_topic").value = c.topic || "#";
          return true;
        }
        return false;
      }

      // 3. MQTT Логика
      function connect() {
        const url = document.getElementById("m_url").value;
        const port = document.getElementById("m_port").value;
        const user = document.getElementById("m_user").value;
        const pass = document.getElementById("m_pass").value;
        const topic = document.getElementById("m_topic").value;

        if (!url) return;

        if (mqttClient) {
          try {
            mqttClient.disconnect();
          } catch (e) {}
        }

        const host = url.replace("wss://", "").split(":")[0];
        mqttClient = new Paho.MQTT.Client(
          host,
          Number(port),
          "js_client_" + Math.random().toString(16).slice(2, 8)
        );

        mqttClient.onConnectionLost = (obj) => {
          const statusEl = document.getElementById("conn-status");
          statusEl.innerText = "Disconnected: " + obj.errorMessage;
          statusEl.className = "status-msg offline";
        };

        mqttClient.onMessageArrived = (msg) => {
          updateUI(msg.payloadString);
        };

        const opts = {
          useSSL: true,
          userName: user,
          password: pass,
          onSuccess: () => {
            const statusEl = document.getElementById("conn-status");
            statusEl.innerText = "Connected Online";
            statusEl.className = "status-msg online";
            mqttClient.subscribe(topic);
          },
          onFailure: (err) => {
            alert("Connection failed: " + err.errorMessage);
          },
        };

        mqttClient.connect(opts);
      }

      // 4. Обновление интерфейса
      function updateUI(payload) {
        // Вывод в RAW DATA
        document.getElementById("raw-output").innerText = JSON.stringify(
          JSON.parse(payload),
          null,
          4
        );

        try {
          const data = JSON.parse(payload);

          // BME Датчики
          if (data["/bme-t"] !== undefined)
            document.getElementById("v-bme-t").innerText =
              data["/bme-t"] + "°C";
          if (data["/bme-h"] !== undefined)
            document.getElementById("v-bme-h").innerText = data["/bme-h"] + "%";
          if (data["/bme-p"] !== undefined)
            document.getElementById("v-bme-p").innerText =
              (data["/bme-p"] / 100).toFixed(1) + " hPa";

          // DHT Датчики
          if (data["/dht-t"] !== undefined)
            document.getElementById("v-dht-t").innerText =
              data["/dht-t"] + "°C";
          if (data["/dht-h"] !== undefined)
            document.getElementById("v-dht-h").innerText = data["/dht-h"] + "%";

          // DS Датчики (массив)
          if (Array.isArray(data.ds)) {
            data.ds.forEach((val, i) => {
              const el = document.getElementById(`v-ds-${i}`);
              if (el) el.innerText = val + "°C";
            });
          }

          // Реле (массив)
          if (Array.isArray(data.r)) {
            data.r.forEach((state, i) => {
              const cb = document.getElementById(`v-r-${i}`);
              if (cb) cb.checked = state;
            });
          }
        } catch (e) {
          console.error("JSON Parse Error", e);
        }
      }

      // Инициализация при старте
      window.onload = () => {
        const hasConfig = initSettings();
        if (hasConfig) {
          showPage("dashboard");
          connect();
        } else {
          showPage("mqtt-settings");
        }
      };
    </script>
  </body>
</html>
