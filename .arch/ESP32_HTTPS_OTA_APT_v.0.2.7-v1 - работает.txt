#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>
#include <HTTPUpdate.h>
#include <ArduinoJson.h>
#include <ESPAsyncWebServer.h>
#include <LittleFS.h>
// #include "FS.h"
// #include "SPIFFS.h"
#include <DNSServer.h>
#include <OneWire.h>
#include <DallasTemperature.h>

#include "SensorsConfig.h" // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∞—Ç—á–∏–∫–æ–≤ –∏ —Å–ª—É–∂–±
Config config;// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫

// --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
static const char* const CURRENT_VERSION = "0.2.6";
const char* AP_SSID = "ESP32_Config_Node";
const int RESET_PIN = 13; 
const int LED_PIN = 2;

enum ConnStatus { W_IDLE, W_CONNECTING, W_SUCCESS, W_FAIL };
ConnStatus wifiConnStatus = W_IDLE;
unsigned long apOffTime = 0;
unsigned long lastLedToggle = 0;

AsyncWebServer server(80);
DNSServer dnsServer;

// // –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö DS18B20
// struct DSConfig {
//   char mac[17];
//   int userIndex;
// };

void initFS(){
  if (!LittleFS.begin(true)) { Serial.println("LittleFS Mount Failed"); return; } // If filesystem - LittleFS
  // if (!SPIFFS.begin(true)) {Serial.println("SPIFFS Mount Failed"); return;  } // If filesystem - SPIFFS
  Serial.println(F("Filesystem mounted successfully."));
}
bool relay_states[4] = {false, false, false, false};

void loadRelays() {
  if (LittleFS.exists("/relays.json")) {
    File f = LittleFS.open("/relays.json", "r");
    StaticJsonDocument<256> doc;
    deserializeJson(doc, f);
    for(int i=0; i<4; i++) relay_states[i] = doc["r"][i] | false;
    f.close();
  }
}

void saveRelays() {
  StaticJsonDocument<256> doc;
  JsonArray r = doc.createNestedArray("r");
  for(int i=0; i<4; i++) r.add(relay_states[i]);
  File f = LittleFS.open("/relays.json", "w");
  serializeJson(doc, f);
  f.close();
}

// --- –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ ---
bool loadConfig() {
  File configFile = LittleFS.open("/config.json", "r");
  if (!configFile) { Serial.println("File config.json not found!"); return false; }
  DynamicJsonDocument doc(6000);
  DeserializationError error = deserializeJson(doc, configFile);
  if (error) { Serial.println(F("Error parsing JSON")); return false; }
  configFile.close();

  // --- SYSTEM ---
  strlcpy(config.system.device_name, doc["s_dn"] | "Smart-Controller-01", 32);
  config.system.reboot_interval = doc["s_rbi"] | 0;

  // --- SERVICES ---
  // WiFi
  strlcpy(config.services.wifi.ssid, doc["s_ssid"] | "", 32);
  strlcpy(config.services.wifi.pass, doc["s_pass"] | "", 64);
  config.services.wifi.ap_mode = doc["s_ap"] | true;

  // Web
  strlcpy(config.services.web.user, doc["u_l"] | "admin", 32);
  strlcpy(config.services.web.pass, doc["u_p"] | "admin", 32);

  // Telegram
  config.services.telegram.enabled = doc["tg_en"] | false;
  strlcpy(config.services.telegram.token, doc["tg_t"] | "", 64);
  config.services.telegram.ids_count = doc["tg_c"] | 0;
  for (int i = 0; i < 6; i++) {
    config.services.telegram.ids[i] = doc["tg_ids"][i] | 0;
  }

  // MQTT
  config.services.mqtt.enabled = doc["m_en"] | false;
  strlcpy(config.services.mqtt.host, doc["m_ip"] | "192.168.1.2", 32);
  config.services.mqtt.port = doc["m_port"] | 1883;
  strlcpy(config.services.mqtt.user, doc["m_u"] | "user", 32);
  strlcpy(config.services.mqtt.pass, doc["m_p"] | "password", 32);
  strlcpy(config.services.mqtt.base_topic, doc["m_bt"] | "home/sensor1", 64);
  config.services.mqtt.interval = doc["m_i"] | 5;

  // --- NODES: CLIMATE ---
  char labels[3][32] = {"Temperature", "Humadity", "Peassure"};
  char units[3][8] = {"¬∞C", "%", "Pa"};
  
  // BME280
  char bme_cards[3][16] = {"card-bme-t", "card-bme-h", "card-bme-p"};
  char bme_topics[3][16] = {"/bme-t", "/bme-h", "/bme-p"};
  config.nodes.climate.bme280.enabled = doc["bme_en"] | false;
  strlcpy(config.nodes.climate.bme280.type, doc["bme_type"] | "I2C", 4);
  for (int i = 0; i < 3; i++) {
    strlcpy(config.nodes.climate.bme280.labels[i], doc["bme_l"][i] | labels[i], 32);
    strlcpy(config.nodes.climate.bme280.units[i], doc["bme_u"][i] | units[i], 8);
    strlcpy(config.nodes.climate.bme280.ui_cards[i], doc["bme_c"][i] | bme_cards[i], 16);
    strlcpy(config.nodes.climate.bme280.topics[i], doc["bme_t"][i] | bme_topics[i], 16);
  }

  // DHT22  
  char dht_cards[3][16] = {"card-dht-t", "card-dht-h"};
  char dht_topics[3][16] = {"/dht-t", "/dht-h"};
  config.nodes.climate.dht22.enabled = doc["dht_en"] | false;
  config.nodes.climate.dht22.pins[0] = doc["dht_p"][0] | 15;
  for (int i = 0; i < 2; i++) {
    strlcpy(config.nodes.climate.dht22.labels[i], doc["dht_l"][i] | labels[i], 32);
    strlcpy(config.nodes.climate.dht22.units[i], doc["dht_u"][i] | units[i], 8);
    strlcpy(config.nodes.climate.dht22.ui_cards[i], doc["dht_c"][i] | dht_cards[i], 16);
    strlcpy(config.nodes.climate.dht22.topics[i], doc["dht_t"][i] | dht_topics[i], 16);
  }

  // DS18B20
  char ds_labels[4][32] = {"Radiator 1", "Radiator 2", "Radiator 3", "Radiator 4"};
  char ds_cards[4][16] = {"card-t1", "card-t2", "card-t3", "card-t4"};
  char ds_topics[4][16] = {"/t1", "/t2", "/t3", "/t4"};
  config.nodes.climate.ds18b20.enabled = doc["ds_en"] | false;
  config.nodes.climate.ds18b20.pins[0] = doc["ds_p"][0] | 4;
  strlcpy(config.nodes.climate.ds18b20.units[0], doc["ds_u"][0] | units[0], 8);
  for (int i = 0; i < 4; i++) {
    strlcpy(config.nodes.climate.ds18b20.macs[i], doc["ds_m"][i] | "", 18);
    strlcpy(config.nodes.climate.ds18b20.labels[i], doc["ds_l"][i] | labels[i], 32);
    strlcpy(config.nodes.climate.ds18b20.ui_cards[i], doc["ds_c"][i] | ds_cards[i], 16);
    strlcpy(config.nodes.climate.ds18b20.topics[i], doc["ds_t"][i] | ds_topics[i], 16);  
  }

  // TCRT5000
  config.nodes.climate.tcrt5000.enabled = doc["tcrt_en"] | false;
  strlcpy(config.nodes.climate.tcrt5000.type, doc["bme_type"] | "I2C", 4);
  strlcpy(config.nodes.climate.tcrt5000.labels[0], doc["tcrt_l"][0] | "–û—Å–≤–µ—â–µ–Ω–∏–µ (TCRT)", 32);
  strlcpy(config.nodes.climate.tcrt5000.units[0], doc["tcrt_u"][0] | "Lux", 8);
  strlcpy(config.nodes.climate.tcrt5000.ui_cards[0], doc["tcrt_c"][0] | "card-tcrt", 16);
  strlcpy(config.nodes.climate.tcrt5000.topics[0], doc["tcrt_t"][0] | "/lux", 16);  
  // --- NODES: BINARY ---
  // PIR
  config.nodes.binary.pir.enabled = doc["pir_en"] | false;
  config.nodes.binary.pir.pin = doc["pir_p"] | 35;
  strlcpy(config.nodes.binary.pir.type, doc["pir_type"] | "motion", 8);
  strlcpy(config.nodes.binary.pir.label, doc["pir_l"] | "Motion", 32);
  strlcpy(config.nodes.binary.pir.ui_card, doc["pir_c"] | "card-pir", 16);
  strlcpy(config.nodes.binary.pir.topic, doc["pir_t"] | "/motion", 16);

  // LD2420
  config.nodes.binary.ld2420.enabled = doc["ld24_en"] | false;
  config.nodes.binary.ld2420.pin = doc["ld24_p"] | 35;
  strlcpy(config.nodes.binary.ld2420.type, doc["ld24_type"] | "presence", 12);
  strlcpy(config.nodes.binary.ld2420.label, doc["ld24_l"] | "Presence", 32);
  strlcpy(config.nodes.binary.ld2420.ui_card, doc["ld24_c"] | "card-pres", 16);
  strlcpy(config.nodes.binary.ld2420.topic, doc["ld24_t"] | "/presence", 16);

  // Door
  config.nodes.binary.door.enabled = doc["door_en"] | false;
  config.nodes.binary.door.pin = doc["door_p"] | 36;
  strlcpy(config.nodes.binary.door.type, doc["door_type"] | "contact", 8);
  strlcpy(config.nodes.binary.door.label, doc["door_l"] | "Door", 32);
  strlcpy(config.nodes.binary.door.ui_card, doc["door_c"] | "card-door", 16);
  strlcpy(config.nodes.binary.door.topic, doc["door_t"] | "/door", 16);

  // Flood
  config.nodes.binary.flood.enabled = doc["fl_en"] | false;
  config.nodes.binary.flood.pin = doc["fl_p"] | 34;
  strlcpy(config.nodes.binary.flood.type, doc["fl_type"] | "leak", 8);
  strlcpy(config.nodes.binary.flood.label, doc["fl_l"] | "Leak", 32);
  strlcpy(config.nodes.binary.flood.ui_card, doc["fl_c"] | "card-flood", 16);
  strlcpy(config.nodes.binary.flood.topic, doc["fl_t"] | "/flood", 16);

  // --- NODES: ANALOG ---
  config.nodes.analog.light_resistor.enabled = doc["5516_en"] | false;
  config.nodes.analog.light_resistor.pin = doc["5516_p"] | 39;
  strlcpy(config.nodes.analog.light_resistor.type, doc["5516_type"] | "light", 8);
  strlcpy(config.nodes.analog.light_resistor.label, doc["5516_l"] | "Light (LDR)", 32);
  strlcpy(config.nodes.analog.light_resistor.ui_card, doc["5516_c"] | "card-lux-5516", 16);
  strlcpy(config.nodes.analog.light_resistor.topic, doc["5516_t"] | "/lux_raw", 16);

  // --- NODES: ACTUATORS ---
  int r_pins[4] = {26, 27, 14, 13};
  char r_labels[4][32]={"Rele 1", "Rele 2", "Rele 3", "Rele 4"};
  char r_cards[4][16]={"card-r0", "card-r1", "card-r2", "card-r3"};
  char r_topics[4][16]={"/r0", "/r1", "/r2", "/r3"};
  config.nodes.actuators.relays.enabled = doc["r_en"] | false;
  for (int i = 0; i < 4; i++) {
    config.nodes.actuators.relays.pins[i] = doc["r_p"][i] | r_pins[i];
    strlcpy(config.nodes.actuators.relays.labels[i], doc["r_l"][i] | r_labels[i], 32);
    strlcpy(config.nodes.actuators.relays.ui_cards[i], doc["r_c"][i] | r_cards[i], 16);
    strlcpy(config.nodes.actuators.relays.topics[i], doc["r_t"][i] | r_topics[i], 16);
  }

  Serial.println("Settings loaded. OK!");
  return true;
}

bool saveConfig() {
  File configFile = LittleFS.open("/config.json", "w");
  if (!configFile) {Serial.println("Failed to open config.json for writing"); return false; }
  DynamicJsonDocument doc(6000); 

  // --- SYSTEM ---
  doc["s_dn"] = config.system.device_name;
  doc["s_rbi"] = config.system.reboot_interval;

  // --- SERVICES ---
  doc["s_ssid"] = config.services.wifi.ssid;
  doc["s_pass"] = config.services.wifi.pass;
  doc["s_ap"] = config.services.wifi.ap_mode;

  doc["u_l"] = config.services.web.user;
  doc["u_p"] = config.services.web.pass;

  doc["tg_en"] = config.services.telegram.enabled;
  doc["tg_t"] = config.services.telegram.token;
  doc["tg_c"] = config.services.telegram.ids_count;
  JsonArray tg_ids = doc.createNestedArray("tg_ids");
  for (int i = 0; i < 6; i++) tg_ids.add(config.services.telegram.ids[i]);

  doc["m_en"] = config.services.mqtt.enabled;
  doc["m_ip"] = config.services.mqtt.host;
  doc["m_port"] = config.services.mqtt.port;
  doc["m_u"] = config.services.mqtt.user;
  doc["m_p"] = config.services.mqtt.pass;
  doc["m_bt"] = config.services.mqtt.base_topic;
  doc["m_i"] = config.services.mqtt.interval;

  // --- NODES: CLIMATE ---
  // BME280
  doc["bme_en"] = config.nodes.climate.bme280.enabled;
  doc["bme_type"] = config.nodes.climate.bme280.type;
  JsonArray bme_l = doc.createNestedArray("bme_l");
  JsonArray bme_u = doc.createNestedArray("bme_u");
  JsonArray bme_c = doc.createNestedArray("bme_c");
  JsonArray bme_t = doc.createNestedArray("bme_t");
  for (int i = 0; i < 3; i++) {
    bme_l.add(config.nodes.climate.bme280.labels[i]);
    bme_u.add(config.nodes.climate.bme280.units[i]);
    bme_c.add(config.nodes.climate.bme280.ui_cards[i]);
    bme_t.add(config.nodes.climate.bme280.topics[i]);
  }

  // DHT22
  doc["dht_en"] = config.nodes.climate.dht22.enabled;
  JsonArray dht_p = doc.createNestedArray("dht_p");
  dht_p.add(config.nodes.climate.dht22.pins[0]);
  JsonArray dht_l = doc.createNestedArray("dht_l");
  JsonArray dht_u = doc.createNestedArray("dht_u");
  JsonArray dht_c = doc.createNestedArray("dht_c");
  JsonArray dht_t = doc.createNestedArray("dht_t");
  for (int i = 0; i < 2; i++) {
    dht_l.add(config.nodes.climate.dht22.labels[i]);
    dht_u.add(config.nodes.climate.dht22.units[i]);
    dht_c.add(config.nodes.climate.dht22.ui_cards[i]);
    dht_t.add(config.nodes.climate.dht22.topics[i]);
  }

  // DS18B20
  doc["ds_en"] = config.nodes.climate.ds18b20.enabled;
  JsonArray ds_p = doc.createNestedArray("ds_p");
  ds_p.add(config.nodes.climate.ds18b20.pins[0]);
  JsonArray ds_u = doc.createNestedArray("ds_u");
  ds_u.add(config.nodes.climate.ds18b20.units[0]);
  JsonArray ds_m = doc.createNestedArray("ds_m");
  JsonArray ds_l = doc.createNestedArray("ds_l");
  JsonArray ds_c = doc.createNestedArray("ds_c");
  JsonArray ds_t = doc.createNestedArray("ds_t");
  for (int i = 0; i < 4; i++) {
    ds_m.add(config.nodes.climate.ds18b20.macs[i]);
    ds_l.add(config.nodes.climate.ds18b20.labels[i]);
    ds_c.add(config.nodes.climate.ds18b20.ui_cards[i]);
    ds_t.add(config.nodes.climate.ds18b20.topics[i]);
  }

  // TCRT5000
  doc["tcrt_en"] = config.nodes.climate.tcrt5000.enabled;
  doc["tcrt_type"] = config.nodes.climate.tcrt5000.type;
  JsonArray tcrt_l = doc.createNestedArray("tcrt_l");
  tcrt_l.add(config.nodes.climate.tcrt5000.labels[0]);
  JsonArray tcrt_u = doc.createNestedArray("tcrt_u");
  tcrt_u.add(config.nodes.climate.tcrt5000.units[0]);
  JsonArray tcrt_c = doc.createNestedArray("tcrt_c");
  tcrt_c.add(config.nodes.climate.tcrt5000.ui_cards[0]);
  JsonArray tcrt_t = doc.createNestedArray("tcrt_t");
  tcrt_t.add(config.nodes.climate.tcrt5000.topics[0]);

  // --- NODES: BINARY ---
  // PIR
  doc["pir_en"] = config.nodes.binary.pir.enabled;
  doc["pir_p"] = config.nodes.binary.pir.pin;
  doc["pir_type"] = config.nodes.binary.pir.type;
  doc["pir_l"] = config.nodes.binary.pir.label;
  doc["pir_c"] = config.nodes.binary.pir.ui_card;
  doc["pir_t"] = config.nodes.binary.pir.topic;

  // LD2420
  doc["ld24_en"] = config.nodes.binary.ld2420.enabled;
  doc["ld24_p"] = config.nodes.binary.ld2420.pin;
  doc["ld24_type"] = config.nodes.binary.ld2420.type;
  doc["ld24_l"] = config.nodes.binary.ld2420.label;
  doc["ld24_c"] = config.nodes.binary.ld2420.ui_card;
  doc["ld24_t"] = config.nodes.binary.ld2420.topic;

  // Door
  doc["door_en"] = config.nodes.binary.door.enabled;
  doc["door_p"] = config.nodes.binary.door.pin;
  doc["door_type"] = config.nodes.binary.door.type;
  doc["door_l"] = config.nodes.binary.door.label;
  doc["door_c"] = config.nodes.binary.door.ui_card;
  doc["door_t"] = config.nodes.binary.door.topic;

  // Flood
  doc["fl_en"] = config.nodes.binary.flood.enabled;
  doc["fl_p"] = config.nodes.binary.flood.pin;
  doc["fl_type"] = config.nodes.binary.flood.type;
  doc["fl_l"] = config.nodes.binary.flood.label;
  doc["fl_c"] = config.nodes.binary.flood.ui_card;
  doc["fl_t"] = config.nodes.binary.flood.topic;

  // --- NODES: ANALOG ---
  doc["5516_en"] = config.nodes.analog.light_resistor.enabled;
  doc["5516_p"] = config.nodes.analog.light_resistor.pin;
  doc["5516_type"] = config.nodes.analog.light_resistor.type;
  doc["5516_l"] = config.nodes.analog.light_resistor.label;
  doc["5516_c"] = config.nodes.analog.light_resistor.ui_card;
  doc["5516_t"] = config.nodes.analog.light_resistor.topic;

  // --- NODES: ACTUATORS ---
  doc["r_en"] = config.nodes.actuators.relays.enabled;
  JsonArray r_p = doc.createNestedArray("r_p");
  JsonArray r_l = doc.createNestedArray("r_l");
  JsonArray r_c = doc.createNestedArray("r_c");
  JsonArray r_t = doc.createNestedArray("r_t");
  for (int i = 0; i < 4; i++) {
    r_p.add(config.nodes.actuators.relays.pins[i]);
    r_l.add(config.nodes.actuators.relays.labels[i]);
    r_c.add(config.nodes.actuators.relays.ui_cards[i]);
    r_t.add(config.nodes.actuators.relays.topics[i]);
  }

  if (serializeJson(doc, configFile) == 0) {
    Serial.println("Failed to write to file");
  }

  configFile.close();
  // printConfigFile();
  Serial.println("Settings saved. OK!");
  return true;
}

// --- HTML –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        background: #f0f2f5;
        color: #1c1e21;
      }
      .nav {
        display: flex;
        background: #fff;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .nav-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        border-bottom: 3px solid transparent;
      }
      .nav-tab.active {
        border-bottom: 3px solid #007bff;
        color: #007bff;
        font-weight: bold;
      }
      .container {
        padding: 10px;
        max-width: 600px;
        margin: auto;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }
      .card-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
      }
      .card {
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .card h4 {
        margin: 0 0 5px 0;
        font-size: 13px;
        color: #666;
        text-transform: uppercase;
      }
      .card div {
        font-size: 22px;
        font-weight: bold;
        color: #007bff;
      }
      .section {
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
      }
      .row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
      }
      .row label {
        width: 110px;
        font-size: 13px;
        font-weight: 600;
      }
      .btn {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 12px;
        border-radius: 8px;
        width: 100%;
        cursor: pointer;
        font-size: 15px;
        font-weight: bold;
      }
      .btn-scan {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 6px;
        width: 100%;
        cursor: pointer;
        margin: 10px 0;
      }
      .pass-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
      }
      .pass-wrapper input {
        width: 100%;
        padding: 8px 35px 8px 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      .toggle-eye {
        position: absolute;
        right: 10px;
        cursor: pointer;
        color: #999;
        font-size: 18px;
        user-select: none;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        vertical-align: middle;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #28a745;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
      .net-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 14px;
      }
      .net-item:hover {
        background: #f8f9fa;
      }
      .details {
        background: #fff;
        border-radius: 8px;
        margin-bottom: 6px;
        border: 1px solid #eee;
        overflow: hidden;
      }
      summary {
        padding: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-weight: 500;
        outline: none;
      }
      details-content {
        padding: 15px;
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
      }
      .acc-item {
        background: #fff;
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
        border: 1px solid #eee;
      }
      .acc-header {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        cursor: pointer;
        background: #fff;
        justify-content: space-between;
      }
      .acc-panel {
        display: none;
        padding: 15px;
        border-top: 1px solid #eee;
        background: #fafafa;
      }
      .acc-panel.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="nav">
      <div class="nav-tab active" onclick="openTab(event, 'tab-mon')">
        Monitor
      </div>
      <div class="nav-tab" onclick="openTab(event, 'tab-sens')">Sensors</div>
      <div class="nav-tab" onclick="openTab(event, 'tab-srv')">Services</div>
    </div>
    <div class="container">
      <div id="tab-mon" class="page active">
        <div class="card-grid">
          <div class="card" id="card-dht-t">
            <h4>–¢.–í–Ω—É—Ç—Ä.</h4>
            <div id="v_in_t">--</div>
          </div>
          <div class="card" id="card-dht-h">
            <h4>–í–ª.–í–Ω—É—Ç—Ä.</h4>
            <div id="v_in_h">--</div>
          </div>
          <div class="card" id="card-lux-5516">
            <h4>–°–≤–µ—Ç –í–Ω.</h4>
            <div id="v_lux">--</div>
          </div>
          <div class="card" id="card-tcrt">
            <h4>–°–≤–µ—Ç –ù–∞—Ä.</h4>
            <div id="v_lux_out">--</div>
          </div>
          <div class="card" id="card-pir">
            <h4>–î–≤–∏–∂–µ–Ω–∏–µ</h4>
            <div id="v_pir">--</div>
          </div>
          <div class="card" id="card-pres">
            <h4>–ü—Ä–∏—Å—É—Ç.</h4>
            <div id="v_pres">--</div>
          </div>
          <div class="card" id="card-bme-t">
            <h4>–¢.–ù–∞—Ä—É–∂.</h4>
            <div id="v_out_t">--</div>
          </div>
          <div class="card" id="card-bme-h">
            <h4>–í–ª.–ù–∞—Ä—É–∂.</h4>
            <div id="v_out_h">--</div>
          </div>
          <div class="card" id="card-bme-p">
            <h4>–î–∞–≤–ª.–ù–∞—Ä—É–∂.</h4>
            <div id="v_out_p">--</div>
          </div>
          <div class="card" id="card-t1">
            <h4>–¢1 –†–∞–¥.</h4>
            <div id="v_t1">--</div>
          </div>
          <div class="card" id="card-t2">
            <h4>–¢2 –†–∞–¥.</h4>
            <div id="v_t2">--</div>
          </div>
          <div class="card" id="card-t3">
            <h4>–¢3 –†–∞–¥.</h4>
            <div id="v_t3">--</div>
          </div>
          <div class="card" id="card-t4">
            <h4>–¢4 –†–∞–¥.</h4>
            <div id="v_t4">--</div>
          </div>
          <div class="card" id="card-door">
            <h4>–î–≤–µ—Ä—å</h4>
            <div id="v_door">--</div>
          </div>
          <div class="card" id="card-flood">
            <h4>–ó–∞—Ç–æ–ø.</h4>
            <div id="v_flood">--</div>
          </div>
          <div class="card" id="card-r0">
            <h4>–†–µ–ª–µ 1</h4>
            <label class="switch"
              ><input type="checkbox" id="r0" onchange="setRelay(0)" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="card" id="card-r1">
            <h4>–†–µ–ª–µ 2</h4>
            <label class="switch"
              ><input type="checkbox" id="r1" onchange="setRelay(1)" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="card" id="card-r2">
            <h4>–†–µ–ª–µ 3</h4>
            <label class="switch"
              ><input type="checkbox" id="r2" onchange="setRelay(2)" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="card" id="card-r3">
            <h4>–†–µ–ª–µ 4</h4>
            <label class="switch"
              ><input type="checkbox" id="r3" onchange="setRelay(3)" /><span
                class="slider"
              ></span
            ></label>
          </div>
        </div>
      </div>

      <div id="tab-sens" class="page">
        <div id="acc-cont">
          <!-- Sensor BME280 -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"
                ><b>BME280</b> (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –í–ª–∞–∂–Ω–æ—Å—Ç—å, –î–∞–∞–≤–ª–µ–Ω–∏–µ)</span
              >
              <label class="switch"
                ><input type="checkbox" id="bme_en" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label
                ><input
                  type="text"
                  value="I2C (SDA/SCL)"
                  readonly
                  style="background: #eee"
                />
              </div>
              <button class="btn-scan" onclick="scan('bme280')">
                Search BME280
              </button>
              <div id="res_bme280"></div>
            </div>
          </div>

          <!-- Sensor DHT22 -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"
                ><b>DHT22</b> (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –í–ª–∞–∂–Ω–æ—Å—Ç—å)</span
              >
              <label class="switch"
                ><input type="checkbox" id="dht_en" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="dht_p" />
              </div>
              <button class="btn-scan" onclick="scan('dht22')">
                Search DHT22
              </button>
              <div id="res_dht280"></div>
            </div>
          </div>

          <!-- Sensor DS18B20 -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"
                ><b>DS18B20</b> (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)</span
              >
              <label class="switch"
                ><input type="checkbox" id="ds_en" /><span class="slider"></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="ds_p" />
              </div>
              <button class="btn-scan" onclick="scan('ds18b20')">
                Search DS18B20
              </button>
              <div id="res_ds18b20"></div>
            </div>
          </div>

          <!-- Sensor TCRT5000 -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>TCRT5000</b> (–û—Å–≤–µ—â–µ–Ω–∏–µ)</span>
              <label class="switch"
                ><input type="checkbox" id="tcrt_en" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label
                ><input
                  type="text"
                  value="I2C (SDA/SCL)"
                  readonly
                  style="background: #eee"
                />
              </div>
              <button class="btn-scan" onclick="scan('tcrt5000')">
                Search TCRT5000
              </button>
              <div id="res_tcrt5000"></div>
            </div>
          </div>

          <!-- Sensor PIR -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>PIR</b> (–î–≤–∏–∂–µ–Ω–∏–µ)</span>
              <label class="switch"
                ><input type="checkbox" id="pir_en" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="pir_p" />
              </div>
              <button class="btn-scan" onclick="scan('pir')">Search PIR</button>
              <div id="res_pir"></div>
            </div>
          </div>

          <!-- Sensor LD2420 -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>LD2420</b> (–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ)</span>
              <label class="switch"
                ><input type="checkbox" id="ld_en" /><span class="slider"></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="ld_p" />
              </div>
              <button class="btn-scan" onclick="scan('ld2420')">
                Search LD2420
              </button>
              <div id="res_ld2420"></div>
            </div>
          </div>

          <!-- Sensor DOOR -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>DOOR</b> (–î–≤–µ—Ä—å)</span>
              <label class="switch"
                ><input type="checkbox" id="door_en" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="door_p" />
              </div>
              <button class="btn-scan" onclick="scan('door')">
                Search DOOR
              </button>
              <div id="res_door"></div>
            </div>
          </div>

          <!-- Sensor FLOOD -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>FLOOD</b> (–ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ)</span>
              <label class="switch"
                ><input type="checkbox" id="fl_en" /><span class="slider"></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="fl_p" />
              </div>
              <button class="btn-scan" onclick="scan('flood')">
                Search FLOOD
              </button>
              <div id="res_flood"></div>
            </div>
          </div>

          <!-- Sensor Resistor 5516 -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"
                ><b>Resistor 5516</b> (–û—Å–≤–µ—â–µ–Ω–∏–µ)</span
              >
              <label class="switch"
                ><input type="checkbox" id="5516_en" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="5516_p" />
              </div>
              <button class="btn-scan" onclick="scan('5516')">
                Search Resistor 5516
              </button>
              <div id="res_5516"></div>
            </div>
          </div>

          <!-- Sensor RELE -->
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>RELEx4</b> (–ë–ª–æ–∫ —Ä–µ–ª–µ)</span>
              <label class="switch"
                ><input type="checkbox" id="r_en" /><span class="slider"></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>R1 GPIO:</label><input type="number" id="r_p0" />
              </div>
              <div class="row">
                <label>R2 GPIO:</label><input type="number" id="r_p1" />
              </div>
              <div class="row">
                <label>R3 GPIO:</label><input type="number" id="r_p2" />
              </div>
              <div class="row">
                <label>R4 GPIO:</label><input type="number" id="r_p3" />
              </div>
              <button class="btn-scan" onclick="scan('rele')">
                –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
              </button>
            </div>
          </div>
        </div>
        <button class="btn" style="margin-top: 15px" onclick="saveSens()">
          Save settings :
        </button>
      </div>

      <div id="tab-srv" class="page">
        <div class="section">
          <h3>
            Wi-Fi<label style="font-size: 12px; float: right"
              >Activate <input type="checkbox" id="wifi_en"
            /></label>
          </h3>
          <button class="btn" onclick="scanWiFi()">Scan Wi-Fi</button>
          <div
            id="nets"
            style="
              margin-top: 10px;
              max-height: 250px;
              overflow-y: auto;
              border: 1px solid #eee;
              border-radius: 8px;
            "
          ></div>
          <div class="row" style="margin-top: 15px">
            <label>SSID</label
            ><input
              id="ssid"
              readonly
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Password</label>
            <div class="pass-wrapper">
              <input id="w_pass" type="password" /><span
                class="toggle-eye"
                onclick="togglePass('w_pass')"
                >üëÅÔ∏è</span
              >
            </div>
          </div>
          <button class="btn" style="background: #28a745" onclick="connWiFi()">
            Connect
          </button>
        </div>
        <div
          id="curr-conn"
          class="section"
          style="display: none; border: 2px solid #28a745; margin-top: 15px"
        >
          <h3 style="color: #28a745; margin-top: 0; font-size: 16px">
            Connected to:
          </h3>
          <div class="row">
            <label>SSID</label
            ><span id="cur_ssid" style="font-weight: bold"></span>
          </div>
          <div class="row">
            <label>IP</label><span id="cur_ip" style="font-weight: bold"></span>
          </div>
          <div class="row"><label>RSSI</label><span id="cur_rssi"></span></div>
          <div class="row">
            <label>Link</label
            ><a
              id="cur_link"
              href=""
              target="_blank"
              style="color: #007bff; font-weight: bold; word-break: break-all"
            ></a>
          </div>
        </div>
        <div class="section">
          <h3>
            Telegram
            <label style="font-size: 12px; float: right"
              >Activate <input type="checkbox" id="tg_en"
            /></label>
          </h3>
          <div class="row">
            <label>Bot Token</label
            ><input
              id="tg_token"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div id="ids-container"></div>
          <button
            class="btn"
            style="background: #28a745; margin-bottom: 10px; padding: 8px"
            onclick="addUserId()"
          >
            + Add UserID
          </button>
        </div>
        <div class="section">
          <h3>
            MQTT
            <label style="font-size: 12px; float: right"
              >Activate <input type="checkbox" id="mqtt_en"
            /></label>
          </h3>
          <div class="row">
            <label>Broker IP</label
            ><input
              id="m_ip"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Port</label><input id="m_port" type="number" />
          </div>
          <div class="row">
            <label>User</label
            ><input
              id="m_u"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Pass</label>
            <div class="pass-wrapper">
              <input id="m_p" type="password" /><span
                class="toggle-eye"
                onclick="togglePass('m_p')"
                >üëÅÔ∏è</span
              >
            </div>
          </div>
          <div class="row">
            <label>Topic</label
            ><input
              id="m_t"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Interval (s)</label><input id="m_i" type="number" />
          </div>
        </div>
        <div class="section">
          <h3>Web Security</h3>
          <div class="row">
            <label>Login</label
            ><input
              id="w_u"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Password</label>
            <div class="pass-wrapper">
              <input id="w_p" type="password" /><span
                class="toggle-eye"
                onclick="togglePass('w_p')"
                >üëÅÔ∏è</span
              >
            </div>
          </div>
        </div>
        <button class="btn" onclick="saveSrv()">Save settings</button>
      </div>
    </div>
    <script>
      const BASE_URL = "";
      let activeIds = 0;

      // const SENSOR_MAP = {
      //   bme280_out: {
      //     title: "–ù–∞—Ä—É–∂–Ω—ã–π –≤–æ–∑–¥—É—Ö (BME280)",
      //     cards: ["card-bme-t", "card-bme-h", "card-bme-p"],
      //     gpio: 1,
      //   },
      //   tcrt5000: {
      //     title: "–ù–∞—Ä—É–∂–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (TCRT5000)",
      //     cards: ["card-tcrt"],
      //     gpio: 1,
      //   },
      //   dht22: {
      //     title: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤–æ–∑–¥—É—Ö (DHT22)",
      //     cards: ["card-dht-t", "card-dht-h"],
      //     gpio: 1,
      //   },
      //   lux5516: {
      //     title: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (5516)",
      //     cards: ["card-lux-5516"],
      //     gpio: 1,
      //   },
      //   pir: {
      //     title: "–î–≤–∏–∂–µ–Ω–∏–µ (SR501)",
      //     cards: ["card-pir"],
      //     gpio: 1,
      //   },
      //   presence: {
      //     title: "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ (LD2420)",
      //     cards: ["card-pres"],
      //     gpio: 1,
      //   },
      //   ds18b20: {
      //     title: "–ù–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–±–æ—Ä (DS18B20)",
      //     cards: ["card-t1", "card-t2", "card-t3", "card-t4"],
      //     gpio: 1,
      //     onewire: true,
      //   },
      //   door: {
      //     title: "–î–≤–µ—Ä—å (Magnet)",
      //     cards: ["card-door"],
      //     gpio: 1,
      //   },
      //   flood: {
      //     title: "–ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ (Resistor)",
      //     cards: ["card-flood"],
      //     gpio: 1,
      //   },
      //   relay: {
      //     title: "–†–µ–ª–µ (Block Rele)",
      //     cards: ["card-r0", "card-r1", "card-r2", "card-r3"],
      //     gpio: 4,
      //   },
      // };

      // async function scanDS() {
      //   const pin = document.getElementById("sen_g6").value;
      //   const btn = document.querySelector(".btn-search");
      //   btn.innerText = "–ü–æ–∏—Å–∫...";
      //   try {
      //     const res = await fetch(`${BASE_URL}/api/ds-scan?pin=${pin}`);
      //     const found = await res.json();
      //     const listDiv = document.getElementById("ds-found-list");
      //     listDiv.innerHTML = "";
      //     found.forEach((item, i) => {
      //       listDiv.innerHTML += `
      //             <div class="ds-item" data-mac="${item.m}">
      //                 <span>‚Ññ${i + 1} (${item.m}) <span class="ds-temp">[ ${
      //         item.t
      //       } ¬∞C ]</span></span>
      //                 <input type="number" class="ds-u-idx" value="${i + 1}">
      //             </div>`;
      //     });
      //   } catch (e) {
      //     alert("Scanning error");
      //   } finally {
      //     btn.innerText = "Scan";
      //   }
      // }

      // function buildSensorsMenu() {
      //   const acc = document.getElementById("sensor-accordion");
      //   acc.innerHTML = "";

      //   Object.entries(SENSOR_MAP).forEach(([id, s]) => {
      //     const details = document.createElement("details");

      //     const summary = document.createElement("summary");
      //     summary.innerHTML = `
      //     <input type="checkbox" onchange="toggleSensor('${id}', this.checked)">
      //     <span style="margin-left:8px">${s.title}</span>
      //   `;

      //     const content = document.createElement("div");
      //     content.className = "details-content";

      //     // GPIO inputs
      //     for (let i = 0; i < s.gpio; i++) {
      //       content.innerHTML += `
      //       <div class="row">
      //         <label>GPIO ${i + 1}</label>
      //         <input type="number" min="0" max="39" id="${id}_gpio_${i}">
      //       </div>
      //     `;
      //     }

      //     // DS18B20 special block
      //     if (s.onewire) {
      //       content.innerHTML += `
      //       <button class="btn" onclick="scanDS('${id}')">Scan</button>
      //       <div id="${id}_list"></div>
      //     `;
      //     }

      //     details.appendChild(summary);
      //     details.appendChild(content);
      //     acc.appendChild(details);
      //   });
      // }

      // function toggleSensor(sensorId, state) {
      //   SENSOR_MAP[sensorId].cards.forEach((cardId) => {
      //     const el = document.getElementById(cardId);
      //     if (el) el.style.display = state ? "block" : "none";
      //   });
      // }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–∫–ª–∞–¥–æ–∫
      function openTab(e, n) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document.getElementById(n).classList.add("active");
        e.currentTarget.classList.add("active");
        getSettings(); // –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        pollWifiStatus(); // –∑–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ WiFi
      }

      // –°–∫—Ä—ã—Ç–∏–µ/–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∑–∞–∫–ª–∞–¥–æ–∫
      function toggleSets() {
        const p = document.getElementById("settings-panel");
        p.style.display = p.style.display === "block" ? "none" : "block";
      }

      // –°–∫—Ä—ã—Ç–∏–µ/–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–µ–Ω—é (–∞–∫–∫–∞—Ä–¥–µ–æ–Ω)
      function toggleAcc(el) {
        el.parentElement.nextElementSibling.classList.toggle("show");
      }

      // /–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
      function togglePass(id) {
        const el = document.getElementById(id);
        el.type = el.type === "password" ? "text" : "password";
      }
      // const chBox = document.getElementById("checks");
      // senNames.forEach((n, i) => {
      //   chBox.innerHTML += `<label style="display:block; margin:8px 0; font-size:13px"><input type="checkbox" id="ch${i}"> ${n}</label>`;
      // });

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ UserID –¥–ª—è Telegram
      function addUserId(val = "") {
        if (activeIds >= 6) return;
        const container = document.getElementById("ids-container");
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<label>UserID ${
          activeIds + 1
        }</label><input id="id${activeIds}" value="${val}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px;">`;
        container.appendChild(div);
        activeIds++;
      }
      // const maps = [
      //   ["card-dht-t", "card-dht-h"],
      //   ["card-lux-5516"],
      //   ["card-tcrt"],
      //   ["card-pir"],
      //   ["card-pres"],
      //   ["card-bme-t", "card-bme-h", "card-bme-p"],
      //   ["card-t1", "card-t2", "card-t3", "card-t4"],
      //   ["card-door"],
      //   ["card-flood"],
      // ];
      // function applyVis(senArray, relEn) {
      //   senArray.forEach((en, i) => {
      //     if (maps[i])
      //       maps[i].forEach((id) => {
      //         const el = document.getElementById(id);
      //         if (el) el.style.display = en ? "block" : "none";
      //       });
      //   });
      //   for (let i = 0; i < 4; i++) {
      //     const el = document.getElementById("card-r" + i);
      //     if (el) el.style.display = relEn ? "block" : "none";
      //   }
      // }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ç–µ–π WiFi
      function scanWiFi() {
        const n = document.getElementById("nets");
        n.innerHTML = '<div style="padding:10px">üîé Scanning...</div>';
        fetch(`${BASE_URL}/api/wifi-scan`)
          .then((r) => r.json())
          .then((d) => {
            n.innerHTML = "";
            d.sort((a, b) => b.rssi - a.rssi);
            d.forEach((x) => {
              const i = document.createElement("div");
              i.className = "net-item";
              let sig = x.rssi > -60 ? "üü¢" : x.rssi > -75 ? "üü°" : "üî¥";
              let lock = x.enc ? "üîí" : "üîì";
              i.innerHTML = `<span>${sig} ${lock} <b>${x.ssid}</b></span> <span style="color:#888">${x.rssi} dBm</span>`;
              i.onclick = () => {
                document.getElementById("ssid").value = x.ssid;
              };
              n.appendChild(i);
            });
          })
          .catch((e) => {
            n.innerHTML =
              '<div style="padding:10px; color:red">Scanning error</div>';
          });
      }

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ WiFi
      function pollWifiStatus() {
        fetch(`${BASE_URL}/api/wifi-status`)
          .then((r) => r.json())
          .then((d) => {
            if (d.connected) {
              document.getElementById("curr-conn").style.display = "block";
              document.getElementById("cur_ssid").innerText = d.ssid;
              document.getElementById("cur_ip").innerText = d.ip;
              document.getElementById("cur_rssi").innerText = d.rssi + " dBm";
              const url = "http://" + d.ip + "/";
              const link = document.getElementById("cur_link");
              link.href = url;
              link.innerText = url;
              fetch(`${BASE_URL}/api/ap-disable`);
            } else {
              setTimeout(pollWifiStatus, 3000);
            }
          });
      }

      // fetch(`${BASE_URL}/api/get-all`)
      //   .then((r) => r.json())
      //   .then((c) => {
      //     console.log(c);
      //     // document.getElementById("tg_en").checked = c.tg_en;
      //     // document.getElementById("m_en").checked = c.m_en;
      //     // document.getElementById("bme_en").checked = c.bme_en;
      //     // document.getElementById("dht_en").checked = c.dht_en;
      //     // document.getElementById("ds_en").checked = c.ds_en;
      //     // document.getElementById("tcrt_en").checked = c.tcrt_en;
      //     // document.getElementById("pir_en").checked = c.pir_en;
      //     // document.getElementById("ld_en").checked = c.ld_en;
      //     // document.getElementById("door_en").checked = c.door_en;
      //     // document.getElementById("fl_en").checked = c.fl_en;
      //     // document.getElementById("5516_en").checked = c.5516_en;
      //     // document.getElementById("r_en").checked = c.fl_en;

      //     //document.getElementById("tg_en").checked = c["tg_en"];
      //     //document.getElementById("m_en").checked = c["m_en"];
      //     document.getElementById("bme_en").checked = c["bme_en"];
      //     document.getElementById("dht_en").checked = c["dht_en"];
      //     document.getElementById("ds_en").checked = c["ds_en"];
      //     document.getElementById("tcrt_en").checked = c["tcrt_en"];
      //     document.getElementById("pir_en").checked = c["pir_en"];
      //     document.getElementById("ld_en").checked = c["ld_en"];
      //     document.getElementById("door_en").checked = c["door_en"];
      //     document.getElementById("fl_en").checked = c["fl_en"];
      //     document.getElementById("5516_en").checked = c["5516_en"];
      //     document.getElementById("r_en").checked = c["r_en"];

      //     document.getElementById("m_ip").value = c.m_ip;
      //     document.getElementById("m_port").value = c.m_port;
      //     document.getElementById("m_t").value = c.m_t;
      //     document.getElementById("m_i").value = c.m_i;

      //     for (let i = 0; i < c.ids_c; i++) addUserId(c.ids[i]);
      //     if (activeIds === 0) addUserId("");
      //     // for (let i = 0; i < 9; i++) {
      //     //   if (document.getElementById("ch" + i))
      //     //     document.getElementById("ch" + i).checked = c.sen[i];
      //     // }
      //     //applyVis(c.sen, c.r_en);
      //     pollWifiStatus();
      //   });

      // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –†–ï–õ–ï, –ø–µ—Ä–∏–æ–¥ 1 —Ä–∞–∑ –≤ 1 —Å–µ–∫—É–Ω–¥—É
      setInterval(() => {
        fetch(`${BASE_URL}/api/get-relays`)
          .then((r) => r.json())
          .then((d) => {
            d.r.forEach(
              (v, i) => (document.getElementById("r" + i).checked = v)
            );
          });
      }, 1000);

      // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Å –¥–∞—Ç—á–∏–∫–æ–≤, –ø–µ—Ä–∏–æ–¥ 1 —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
      setInterval(() => {
        fetch(`${BASE_URL}/api/values`)
          .then((r) => r.json())
          .then((v) => {
            [
              "in_t",
              "in_h",
              "out_t",
              "out_h",
              "lux",
              "lux_out",
              "t1",
              "t2",
            ].forEach((f) => {
              if (document.getElementById("v_" + f))
                document.getElementById("v_" + f).innerText = v[f];
            });
            const updateStatus = (id, val, tT, tF) => {
              const el = document.getElementById(id);
              if (!el) return;
              el.innerText = val ? tT : tF;
              el.style.color = val ? "red" : "#007bff";
            };
            updateStatus("v_pir", v.pir, "–ï–°–¢–¨", "–ù–ï–¢");
            updateStatus("v_pres", v.pres, "–ï–°–¢–¨", "–ù–ï–¢");
            updateStatus("v_door", v.door, "–û–¢–ö–†", "–ó–ê–ö–†");
            updateStatus("v_flood", v.flood, "–ï–°–¢–¨", "–ù–ï–¢");
          });
      }, 2000);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–ª–µ
      function setRelay(idx) {
        const st = document.getElementById("r" + idx).checked;
        fetch(`${BASE_URL}/api/set-relay?id=${idx}&st=${st}`);
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ SSID/PASS –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ WiFi
      function connWiFi() {
        const f = new FormData();
        f.append("s", document.getElementById("ssid").value);
        f.append("p", document.getElementById("w_pass").value);
        fetch(`${BASE_URL}/api/wifi-connect`, { method: "POST", body: f }).then(
          () => {
            alert("Connecting to WiFi...");
            pollWifiStatus();
          }
        );
      }

      // /* –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∞—Ç—á–∏–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ */
      // document.addEventListener("DOMContentLoader", (event) => {
      //   console.log("DOM full loaded.");
      //   getSettings();
      // });

      document.addEventListener("DOMContentLoaded", getSettings());

      function getSettings() {
        // –í—ã–ø–æ–ª–Ω—è–µ–º GET –∑–∞–ø—Ä–æ—Å –∫ API
        fetch(`${BASE_URL}/api/get-all`) // –û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è get-all –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ä–∞–∑—É
          .then((response) => {
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            return response.json();
          })
          .then((data) => {
            const switchers = [
              "tg_en",
              "m_en",
              "bme_en",
              "dht_en",
              "ds_en",
              "tcrt_en",
              "pir_en",
              "ld_en",
              "door_en",
              "fl_en",
              "5516_en",
              "r_en",
            ];

            switchers.forEach((id) => {
              const element = document.getElementById(id);
              if (element) element.checked = data[id];
            });

            document.getElementById("m_ip").value = data[m_ip];
            document.getElementById("m_port").value = data[m_port];
            document.getElementById("m_t").value = data[m_t];
            document.getElementById("m_i").value = data[m_i];

            for (let i = 0; i < data["ids_c"]; i++) addUserId(data.ids[i]);
            if (activeIds === 0) addUserId("");
          })
          .catch((error) => {
            console.error(error);
          });
      }
      function saveSens() {
        const f = new FormData();
        f.append("bme_en", document.getElementById("bme_en").checked);
        f.append("dht_en", document.getElementById("dht_en").checked);
        f.append("ds_en", document.getElementById("ds_en").checked);
        f.append("tcrt_en", document.getElementById("tcrt_en").checked);
        f.append("pir_en", document.getElementById("pir_en").checked);
        f.append("ld_en", document.getElementById("ld_en").checked);
        f.append("door_en", document.getElementById("door_en").checked);
        f.append("fl_en", document.getElementById("fl_en").checked);
        f.append("5516_en", document.getElementById("5516_en").checked);
        f.append("r_en", document.getElementById("r_en").checked);
        fetch(`${BASE_URL}/api/set-sens`, { method: "POST", body: f }).then(
          () => alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        );
      }
      function saveSrv() {
        const f = new FormData();
        f.append("tg_en", document.getElementById("tg_en").checked);
        f.append("tg", document.getElementById("tg_token").value);
        f.append("ids_c", activeIds);
        for (let i = 0; i < activeIds; i++)
          f.append("id" + i, document.getElementById("id" + i).value);
        f.append("m_en", document.getElementById("mqtt_en").checked);
        f.append("m_ip", document.getElementById("m_ip").value);
        f.append("m_port", document.getElementById("m_port").value);
        f.append("m_u", document.getElementById("m_u").value);
        f.append("m_p", document.getElementById("m_p").value);
        f.append("m_t", document.getElementById("m_t").value);
        f.append("m_i", document.getElementById("m_i").value);
        f.append("w_u", document.getElementById("w_u").value);
        f.append("w_p", document.getElementById("w_p").value);
        fetch(`${BASE_URL}/api/set-srv`, { method: "POST", body: f }).then(() =>
          alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        );
      }
    </script>
  </body>
</html>

)rawliteral";

// --- LED Helpers ---
void handleLEDStatus() {
  if (wifiConnStatus == W_CONNECTING) {
    if (millis() - lastLedToggle > 100) { digitalWrite(LED_PIN, !digitalRead(LED_PIN)); lastLedToggle = millis(); }
  } else if (wifiConnStatus == W_IDLE) {
    if (millis() - lastLedToggle > 1000) { digitalWrite(LED_PIN, !digitalRead(LED_PIN)); lastLedToggle = millis(); }
  }
}

// --- API Routing ---
bool isCORS=true;
void setupAPI() {
  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
    if(!request->authenticate(config.services.web.user, config.services.web.pass)) return request->requestAuthentication();
    request->send_P(200, "text/html", index_html);
  });
  server.on("/api/wifi-status", HTTP_GET, [](AsyncWebServerRequest *request){
    StaticJsonDocument<256> doc; bool c = (WiFi.status() == WL_CONNECTED); doc["connected"] = c;
    if(c) { doc["ssid"] = WiFi.SSID(); doc["ip"] = WiFi.localIP().toString(); doc["rssi"] = WiFi.RSSI(); }
    String j; serializeJson(doc, j); 
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200, "application/json", j);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200, "application/json", j);
  });
  server.on("/api/ap-disable", HTTP_GET, [](AsyncWebServerRequest *request){
    if (WiFi.status() == WL_CONNECTED) apOffTime = millis() + 5000; 
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200);
  });
  server.on("/api/values", HTTP_GET, [](AsyncWebServerRequest *request){
    StaticJsonDocument<1024> doc; doc["in_t"] = String(random(220, 250)/10.0, 1); doc["in_h"] = String(random(40, 50));
    doc["lux"] = String(random(100, 500)); 
    doc["lux_out"] = String(random(0, 5000));
    doc["pir"] = random(0, 10) > 8; 
    doc["pres"] = random(0, 10) > 7;
    doc["out_t"] = String(random(-50, 150)/10.0, 1); 
    doc["out_h"] = String(random(60, 90));
    doc["t1"] = String(random(400, 600)/10.0, 1); 
    doc["t2"] = String(random(400, 600)/10.0, 1);
    doc["door"] = random(0, 10) > 7; 
    doc["flood"] = random(0, 10) > 8;
    String j; 
    serializeJson(doc, j); 
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200, "application/json", j);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200, "application/json", j);
  });
  server.on("/api/get-all", HTTP_GET, [](AsyncWebServerRequest *request){
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º DynamicJsonDocument –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–æ–π –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    DynamicJsonDocument doc(5000); 

    // --- System ---
    doc["s_dn"] = config.system.device_name;
    doc["s_rbi"] = config.system.reboot_interval;

    // --- Services: WiFi & Web ---
    doc["s_ssid"] = config.services.wifi.ssid;
    //doc["s_pass"] = config.services.wifi.pass;
    doc["s_ap"]   = config.services.wifi.ap_mode;
    //doc["u_l"]    = config.services.web.user;
    //doc["u_p"]    = config.services.web.pass;

    // --- Services: Telegram ---
    doc["tg_en"] = config.services.telegram.enabled;
    //doc["tg_t"]  = config.services.telegram.token;
    doc["tg_c"]  = config.services.telegram.ids_count;
    JsonArray tg_ids = doc.createNestedArray("tg_ids");
    for(int i=0; i<config.services.telegram.ids_count; i++) tg_ids.add(config.services.telegram.ids[i]);

    // --- Services: MQTT ---
    doc["m_en"]   = config.services.mqtt.enabled;
    doc["m_ip"]   = config.services.mqtt.host;
    doc["m_port"] = config.services.mqtt.port;
    //doc["m_u"]    = config.services.mqtt.user;
    //doc["m_p"]    = config.services.mqtt.pass;
    doc["m_bt"]   = config.services.mqtt.base_topic;
    doc["m_i"]    = config.services.mqtt.interval;

    // --- Nodes: Climate ---
    // --- BME ---
    doc["bme_en"] = config.nodes.climate.bme280.enabled;

    // --- DHT ---
    doc["dht_en"] = config.nodes.climate.dht22.enabled;
    doc["dht_p"][0] = config.nodes.climate.dht22.pins[0];
    
    // --- DS18B20 ---
    doc["ds_en"] = config.nodes.climate.ds18b20.enabled;
    doc["ds_p"][0] = config.nodes.climate.ds18b20.pins[0];
    JsonArray ds_m = doc.createNestedArray("ds_m");
    for(int i=0; i<4; i++) ds_m.add(config.nodes.climate.ds18b20.macs[i]);
    
    // --- TCRT5000 ---
    doc["tcrt_en"] = config.nodes.climate.tcrt5000.enabled;

    // --- Nodes: Binary ---
    // --- SR501 ---
    doc["pir_en"]  = config.nodes.binary.pir.enabled;
    doc["pir_p"]   = config.nodes.binary.pir.pin;

    // --- LD2420 ---
    doc["ld24_en"] = config.nodes.binary.ld2420.enabled;
    doc["ld24_p"]  = config.nodes.binary.ld2420.pin;

    // --- Door ---
    doc["door_en"] = config.nodes.binary.door.enabled;
    doc["door_p"]  = config.nodes.binary.door.pin;

    // --- Flood ---
    doc["fl_en"]   = config.nodes.binary.flood.enabled;
    doc["fl_p"]    = config.nodes.binary.flood.pin;

    // --- Nodes: Analog ---
    // --- Resistor 5516 ---
    doc["5516_en"] = config.nodes.analog.light_resistor.enabled;
    doc["5516_p"]  = config.nodes.analog.light_resistor.pin;

    // --- Nodes: Actuators (Relays) ---
    doc["r_en"] = config.nodes.actuators.relays.enabled;
    JsonArray r_p = doc.createNestedArray("r_p");
    for(int i=0; i<4; i++) r_p.add(config.nodes.actuators.relays.pins[i]);

    // –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
    String responseData;
    serializeJson(doc, responseData);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å —É—á–µ—Ç–æ–º CORS
    if (isCORS) {
        AsyncWebServerResponse *response = request->beginResponse(200, "application/json", responseData);
        response->addHeader("Access-Control-Allow-Origin", "*");
        response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
        response->addHeader("Access-Control-Allow-Headers", "Content-Type");
        request->send(response);
    } else {
        request->send(200, "application/json", responseData);
    }
});
  server.on("/api/get-relays", HTTP_GET, [](AsyncWebServerRequest *request){
    StaticJsonDocument<256> doc; JsonArray r=doc.createNestedArray("r");
    for(int i=0; i<4; i++) r.add(relay_states[i]);
    String j; 
    serializeJson(doc, j); 
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200, "application/json", j);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200, "application/json", j);
  });
  server.on("/api/set-relay", HTTP_GET, [](AsyncWebServerRequest *request){
    if(request->hasParam("id") && request->hasParam("st")) {
      int id = request->getParam("id")->value().toInt(); bool st = request->getParam("st")->value() == "true";
      if(id >= 0 && id < 4) { relay_states[id] = st; saveRelays(); }
    }
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200);
  });

  server.on("/api/wifi-scan", HTTP_GET, [](AsyncWebServerRequest *request){
    int n = WiFi.scanNetworks(false, false, false, 150);
    DynamicJsonDocument doc(3072); JsonArray arr = doc.to<JsonArray>();
    int limit = (n > 25) ? 25 : n;
    for(int i=0; i<limit; i++) {
      JsonObject obj = arr.createNestedObject();
      obj["ssid"] = WiFi.SSID(i); obj["rssi"] = WiFi.RSSI(i);
      obj["enc"] = (WiFi.encryptionType(i) != WIFI_AUTH_OPEN);
    }
    String j; 
    serializeJson(doc, j); 
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200, "application/json", j);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200, "application/json", j);
    WiFi.scanDelete();
  });
  server.on("/api/wifi-connect", HTTP_POST, [](AsyncWebServerRequest *request){
    strlcpy(config.services.wifi.ssid, request->getParam("s", true)->value().c_str(), 32);
    strlcpy(config.services.wifi.pass, request->getParam("p", true)->value().c_str(), 64);
    saveConfig(); 
    wifiConnStatus = W_CONNECTING; 
    WiFi.disconnect(true); // –°–±—Ä–æ—Å –¥—Ä–∞–π–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
    delay(100);
    WiFi.begin(config.services.wifi.ssid, config.services.wifi.pass); 
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200);
  });
  server.on("/api/set-sens", HTTP_POST, [](AsyncWebServerRequest *request){
    // 1. –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞—Ç—á–∏–∫–∏
    if(request->hasParam("bme_en", true)) 
        config.nodes.climate.bme280.enabled = (request->getParam("bme_en", true)->value() == "true");
    
    if(request->hasParam("dht_en", true)) 
        config.nodes.climate.dht22.enabled = (request->getParam("dht_en", true)->value() == "true");
    
    if(request->hasParam("ds_en", true)) 
        config.nodes.climate.ds18b20.enabled = (request->getParam("ds_en", true)->value() == "true");
    
    if(request->hasParam("tcrt_en", true)) 
        config.nodes.climate.tcrt5000.enabled = (request->getParam("tcrt_en", true)->value() == "true");

    // 2. –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ (Binary)
    if(request->hasParam("pir_en", true)) 
        config.nodes.binary.pir.enabled = (request->getParam("pir_en", true)->value() == "true");
    
    if(request->hasParam("ld_en", true)) 
        config.nodes.binary.ld2420.enabled = (request->getParam("ld_en", true)->value() == "true");
    
    if(request->hasParam("door_en", true)) 
        config.nodes.binary.door.enabled = (request->getParam("door_en", true)->value() == "true");
    
    if(request->hasParam("fl_en", true)) 
        config.nodes.binary.flood.enabled = (request->getParam("fl_en", true)->value() == "true");

    // 3. –ê–Ω–∞–ª–æ–≥–æ–≤—ã–µ –¥–∞—Ç—á–∏–∫–∏
    if(request->hasParam("5516_en", true)) 
        config.nodes.analog.light_resistor.enabled = (request->getParam("5516_en", true)->value() == "true");
    // 4. –ê–∫—Ç—É–∞—Ç–æ—Ä—ã (–†–µ–ª–µ)
    if(request->hasParam("r_en", true)) 
        config.nodes.actuators.relays.enabled = (request->getParam("r_en", true)->value() == "true");
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ LittleFS
    saveConfig(); 

    // –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º CORS
    if (isCORS){
        AsyncWebServerResponse *response = request->beginResponse(200);
        response->addHeader("Access-Control-Allow-Origin", "*");
        response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
        response->addHeader("Access-Control-Allow-Headers", "Content-Type");
        request->send(response);
    } else {
        request->send(200);
    }
  });
  server.on("/api/set-srv", HTTP_POST, [](AsyncWebServerRequest *request){
    // --- 1. –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (System) ---
    if(request->hasParam("s_dn", true)) 
        strlcpy(config.system.device_name, request->getParam("s_dn", true)->value().c_str(), 32);
    if(request->hasParam("s_rbi", true)) 
        config.system.reboot_interval = request->getParam("s_rbi", true)->value().toInt();

    // --- 2. WiFi –∏ Web-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Services) ---
    if(request->hasParam("s_ssid", true)) 
        strlcpy(config.services.wifi.ssid, request->getParam("s_ssid", true)->value().c_str(), 32);
    if(request->hasParam("s_pass", true)) 
        strlcpy(config.services.wifi.pass, request->getParam("s_pass", true)->value().c_str(), 64);
    if(request->hasParam("s_ap", true)) 
        config.services.wifi.ap_mode = (request->getParam("s_ap", true)->value() == "true");
    
    if(request->hasParam("u_l", true)) 
        strlcpy(config.services.web.user, request->getParam("u_l", true)->value().c_str(), 32);
    if(request->hasParam("u_p", true)) 
        strlcpy(config.services.web.pass, request->getParam("u_p", true)->value().c_str(), 32);

    // --- 3. Telegram (Services) ---
    if(request->hasParam("tg_en", true)) 
        config.services.telegram.enabled = (request->getParam("tg_en", true)->value() == "true");
    if(request->hasParam("tg_t", true)) 
        strlcpy(config.services.telegram.token, request->getParam("tg_t", true)->value().c_str(), 64);
    if(request->hasParam("tg_c", true)) 
        config.services.telegram.ids_count = request->getParam("tg_c", true)->value().toInt();
    
    // –¶–∏–∫–ª –¥–ª—è —Å–±–æ—Ä–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã id0, id1...id5)
    for(int i = 0; i < 6; i++) {
        String pName = "id" + String(i);
        if(request->hasParam(pName, true)) {
            config.services.telegram.ids[i] = request->getParam(pName, true)->value().toInt();
        }
    }

    // --- 4. MQTT (Services) ---
    if(request->hasParam("m_en", true)) 
        config.services.mqtt.enabled = (request->getParam("m_en", true)->value() == "true");
    if(request->hasParam("m_ip", true)) 
        strlcpy(config.services.mqtt.host, request->getParam("m_ip", true)->value().c_str(), 32);
    if(request->hasParam("m_port", true)) 
        config.services.mqtt.port = request->getParam("m_port", true)->value().toInt();
    if(request->hasParam("m_u", true)) 
        strlcpy(config.services.mqtt.user, request->getParam("m_u", true)->value().c_str(), 32);
    if(request->hasParam("m_p", true)) 
        strlcpy(config.services.mqtt.pass, request->getParam("m_p", true)->value().c_str(), 32);
    if(request->hasParam("m_bt", true)) 
        strlcpy(config.services.mqtt.base_topic, request->getParam("m_bt", true)->value().c_str(), 64);
    if(request->hasParam("m_i", true)) 
        config.services.mqtt.interval = request->getParam("m_i", true)->value().toInt();

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ LittleFS
    saveConfig(); 

    // –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    if (isCORS) {
        AsyncWebServerResponse *response = request->beginResponse(200);
        response->addHeader("Access-Control-Allow-Origin", "*");
        response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
        response->addHeader("Access-Control-Allow-Headers", "Content-Type");
        request->send(response);
    } else {
        request->send(200);
    }
  });
  server.on("/api/ds_scan", HTTP_GET, [](AsyncWebServerRequest *request){
    int pin = request->getParam("pin")->value().toInt();

    OneWire ow(pin);
    DallasTemperature ds(&ow);
    ds.begin();
    ds.requestTemperatures();
    DynamicJsonDocument doc(1024);
    JsonArray arr = doc.to<JsonArray>();
    DeviceAddress addr;
    for (int i = 0; i < ds.getDeviceCount(); i++) {
      ds.getAddress(addr, i);
      JsonObject o = arr.createNestedObject();
      char rom[24];
      sprintf(rom,"%02:%02:%02:%02:%02:%02:%02:%02",
        addr[0],addr[1],addr[2],addr[3],
        addr[4],addr[5],addr[6],addr[7]);
      o["rom"] = rom;
      o["temp"] = ds.getTempC(addr);
    }
    String j;
    serializeJson(doc, j);
    if (isCORS){
      AsyncWebServerResponse *response = request->beginResponse(200, "application/json", j);
      response->addHeader("Access-Control-Allow-Origin", "*");
      response->addHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
      response->addHeader("Access-Control-Allow-Headers", "Content-Type");
      request->send(response);
    } else request->send(200, "application/json", j);
  });
  server.begin();
}

// --- Loop Handlers ---
void handleWiFiStatus() {
  if (WiFi.status() == WL_CONNECTED && wifiConnStatus != W_SUCCESS) {
    wifiConnStatus = W_SUCCESS; digitalWrite(LED_PIN, HIGH);
    Serial.printf("\n>>> Connected! IP: %s\n", WiFi.localIP().toString().c_str());
    if (WiFi.getMode() & WIFI_AP) { apOffTime = millis() + 60000; } 
  }
}

void handleAPTimeout() {
  if (apOffTime > 0 && millis() > apOffTime) { 
    Serial.println("Rebooting to STA only..."); apOffTime = 0;
    WiFi.softAPdisconnect(true); WiFi.mode(WIFI_STA);
    delay(1000); ESP.restart(); 
  }
}

void handleResetButton() {
  if (digitalRead(RESET_PIN) == LOW) {
    bool aborted = false;
    for(int i=0; i<50; i++) { digitalWrite(LED_PIN, !digitalRead(LED_PIN)); delay(100); if(digitalRead(RESET_PIN) == HIGH) { aborted = true; break; } }
    if(!aborted) { LittleFS.format(); delay(500); ESP.restart(); }
    else { digitalWrite(LED_PIN, (wifiConnStatus == W_SUCCESS) ? HIGH : LOW); }
  }
}

// --- Main ---
void setup() {
  Serial.begin(115200);
  initFS();
  pinMode(LED_PIN, OUTPUT); pinMode(RESET_PIN, INPUT_PULLUP);
  loadConfig(); loadRelays();

  WiFi.persistent(false); // –ó–∞–ø—Ä–µ—â–∞–µ–º SDK –º–µ—à–∞—Ç—å –Ω–∞—à–µ–º—É –∫–æ–¥—É

  if(strlen(config.services.wifi.ssid) > 2 && strlen(config.services.wifi.pass) > 4 ) {
    Serial.println("Silent STA attempt...");
    WiFi.mode(WIFI_STA); 
    WiFi.begin(config.services.wifi.ssid, config.services.wifi.pass);
    wifiConnStatus = W_CONNECTING;
    unsigned long startT = millis();
    while (WiFi.status() != WL_CONNECTED && millis() - startT < 15000) { handleLEDStatus(); delay(100); }
  }

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Starting Config AP...");
    WiFi.mode(WIFI_AP_STA); WiFi.softAP(AP_SSID);
    wifiConnStatus = (strlen(config.services.wifi.ssid) > 2) ? W_CONNECTING : W_IDLE;
  } else {
    wifiConnStatus = W_SUCCESS; digitalWrite(LED_PIN, HIGH);
    Serial.print("Success IP: "); Serial.println(WiFi.localIP());
  }
  setupAPI();
}

void loop() {
  handleWiFiStatus();
  handleAPTimeout();
  handleLEDStatus();
  handleResetButton();
}