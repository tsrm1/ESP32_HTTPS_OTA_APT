<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        background: #f0f2f5;
        color: #1c1e21;
      }
      .nav {
        display: flex;
        background: #fff;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .nav-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        border-bottom: 3px solid transparent;
      }
      .nav-tab.active {
        border-bottom: 3px solid #007bff;
        color: #007bff;
        font-weight: bold;
      }
      .container {
        padding: 10px;
        max-width: 600px;
        margin: auto;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }
      .card-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
      }
      .card {
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .card h4 {
        margin: 0 0 5px 0;
        font-size: 13px;
        color: #666;
        text-transform: uppercase;
      }
      .card div {
        font-size: 22px;
        font-weight: bold;
        color: #007bff;
      }
      .section {
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
      }
      .row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
      }
      .row label {
        width: 110px;
        font-size: 13px;
        font-weight: 600;
      }
      .btn {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 12px;
        border-radius: 8px;
        width: 100%;
        cursor: pointer;
        font-size: 15px;
        font-weight: bold;
      }
      .btn-scan {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 6px;
        width: 100%;
        cursor: pointer;
        margin: 10px 0;
      }
      .pass-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
      }
      .pass-wrapper input {
        width: 100%;
        padding: 8px 35px 8px 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      .toggle-eye {
        position: absolute;
        right: 10px;
        cursor: pointer;
        color: #999;
        font-size: 18px;
        user-select: none;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        vertical-align: middle;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #28a745;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
      .net-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 14px;
      }
      .net-item:hover {
        background: #f8f9fa;
      }
      .details {
        background: #fff;
        border-radius: 8px;
        margin-bottom: 6px;
        border: 1px solid #eee;
        overflow: hidden;
      }
      summary {
        padding: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-weight: 500;
        outline: none;
      }
      details-content {
        padding: 15px;
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
      }
      .acc-item {
        background: #fff;
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
        border: 1px solid #eee;
      }
      .acc-header {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        cursor: pointer;
        background: #fff;
        justify-content: space-between;
      }
      .acc-panel {
        display: none;
        padding: 15px;
        border-top: 1px solid #eee;
        background: #fafafa;
      }
      .acc-panel.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="nav">
      <div class="nav-tab active" onclick="openTab(event, 'tab-mon')">
        Monitor
      </div>
      <div class="nav-tab" onclick="openTab(event, 'tab-sens')">Sensors</div>
      <div class="nav-tab" onclick="openTab(event, 'tab-srv')">Services</div>
    </div>
    <div class="container">
      <div id="tab-mon" class="page active">
        <div class="card-grid">
          <div class="card" id="card-in-t">
            <h4>–¢.–í–Ω—É—Ç—Ä.</h4>
            <div id="v_in_t">--</div>
          </div>
          <div class="card" id="card-in-h">
            <h4>–í–ª.–í–Ω—É—Ç—Ä.</h4>
            <div id="v_in_h">--</div>
          </div>
          <div class="card" id="card-lux">
            <h4>–°–≤–µ—Ç –í–Ω.</h4>
            <div id="v_lux">--</div>
          </div>
          <div class="card" id="card-lux-out">
            <h4>–°–≤–µ—Ç –ù–∞—Ä.</h4>
            <div id="v_lux_out">--</div>
          </div>
          <div class="card" id="card-pir">
            <h4>–î–≤–∏–∂–µ–Ω–∏–µ</h4>
            <div id="v_pir">--</div>
          </div>
          <div class="card" id="card-pres">
            <h4>–ü—Ä–∏—Å—É—Ç.</h4>
            <div id="v_pres">--</div>
          </div>
          <div class="card" id="card-out-t">
            <h4>–¢.–ù–∞—Ä—É–∂.</h4>
            <div id="v_out_t">--</div>
          </div>
          <div class="card" id="card-out-h">
            <h4>–í–ª.–ù–∞—Ä—É–∂.</h4>
            <div id="v_out_h">--</div>
          </div>
          <div class="card" id="card-t1">
            <h4>–¢1 –†–∞–¥.</h4>
            <div id="v_t1">--</div>
          </div>
          <div class="card" id="card-t2">
            <h4>–¢2 –†–∞–¥.</h4>
            <div id="v_t2">--</div>
          </div>
          <div class="card" id="card-door">
            <h4>–î–≤–µ—Ä—å</h4>
            <div id="v_door">--</div>
          </div>
          <div class="card" id="card-flood">
            <h4>–ó–∞—Ç–æ–ø.</h4>
            <div id="v_flood">--</div>
          </div>
          <div class="card" id="card-r0">
            <h4>–†–µ–ª–µ 1</h4>
            <label class="switch"
              ><input type="checkbox" id="r0" onchange="setRelay(0)" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="card" id="card-r1">
            <h4>–†–µ–ª–µ 2</h4>
            <label class="switch"
              ><input type="checkbox" id="r1" onchange="setRelay(1)" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="card" id="card-r2">
            <h4>–†–µ–ª–µ 3</h4>
            <label class="switch"
              ><input type="checkbox" id="r2" onchange="setRelay(2)" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <div class="card" id="card-r3">
            <h4>–†–µ–ª–µ 4</h4>
            <label class="switch"
              ><input type="checkbox" id="r3" onchange="setRelay(3)" /><span
                class="slider"
              ></span
            ></label>
          </div>
        </div>
      </div>

      <div id="tab-sens" class="page">
        <div id="acc-cont">
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"
                ><b>DS18B20</b> (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)</span
              >
              <label class="switch"
                ><input type="checkbox" id="en_ds18" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label><input type="number" id="p_ds" value="4" />
              </div>
              <button class="btn-scan" onclick="scan('ds18b20')">
                Scan OneWire Bus
              </button>
              <div id="res_ds18b20"></div>
            </div>
          </div>
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>BME280</b> (I2C)</span>
              <label class="switch"
                ><input type="checkbox" id="en_bme" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>GPIO:</label
                ><input
                  type="text"
                  value="I2C (SDA/SCL)"
                  readonly
                  style="background: #eee"
                />
              </div>
              <button class="btn-scan" onclick="scan('bme280')">
                Scan I2C Bus
              </button>
              <div id="res_bme280"></div>
            </div>
          </div>
          <div class="acc-item">
            <div class="acc-header">
              <span onclick="toggleAcc(this)"><b>RELEx4</b> (–ë–ª–æ–∫ —Ä–µ–ª–µ)</span>
              <label class="switch"
                ><input type="checkbox" id="en_rele" /><span
                  class="slider"
                ></span
              ></label>
            </div>
            <div class="acc-panel">
              <div class="row">
                <label>R1 GPIO:</label><input type="number" id="p_r0" />
              </div>
              <div class="row">
                <label>R2 GPIO:</label><input type="number" id="p_r1" />
              </div>
              <div class="row">
                <label>R3 GPIO:</label><input type="number" id="p_r2" />
              </div>
              <div class="row">
                <label>R4 GPIO:</label><input type="number" id="p_r3" />
              </div>
              <button class="btn-scan" onclick="scan('rele')">
                –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
              </button>
            </div>
          </div>
        </div>
        <button class="btn" style="margin-top: 15px" onclick="saveSensors()">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>

        <div class="section">
          <button
            class="btn"
            style="background: #6c757d"
            onclick="toggleSets()"
          >
            ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞—Ç—á–∏–∫–æ–≤
          </button>
          <div
            id="settings-panel"
            class="section"
            style="display: none; margin-top: 10px"
          >
            <div id="checks"></div>
            <label style="display: block; margin: 8px 0; font-size: 13px"
              ><input type="checkbox" id="relays_en" /> –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ (Block
              Rele)</label
            >
            <button class="btn" onclick="saveChecks()" style="margin-top: 10px">
              –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
          </div>
        </div>
        <div class="section">
          <div id="sensor-accordion"></div>
          <button
            class="btn"
            style="margin-top: 15px; background: #28a745"
            onclick="saveChecks()"
          >
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          </button>
        </div>
      </div>

      <div id="tab-srv" class="page">
        <div class="section">
          <h3>
            Wi-Fi<label style="font-size: 12px; float: right"
              >Activate <input type="checkbox" id="wifi_en"
            /></label>
          </h3>
          <button class="btn" onclick="scanWiFi()">Scan Wi-Fi</button>
          <div
            id="nets"
            style="
              margin-top: 10px;
              max-height: 250px;
              overflow-y: auto;
              border: 1px solid #eee;
              border-radius: 8px;
            "
          ></div>
          <div class="row" style="margin-top: 15px">
            <label>SSID</label
            ><input
              id="ssid"
              readonly
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Password</label>
            <div class="pass-wrapper">
              <input id="w_pass" type="password" /><span
                class="toggle-eye"
                onclick="togglePass('w_pass')"
                >üëÅÔ∏è</span
              >
            </div>
          </div>
          <button class="btn" style="background: #28a745" onclick="conn()">
            Connect
          </button>
        </div>
        <div
          id="curr-conn"
          class="section"
          style="display: none; border: 2px solid #28a745; margin-top: 15px"
        >
          <h3 style="color: #28a745; margin-top: 0; font-size: 16px">
            Connected to:
          </h3>
          <div class="row">
            <label>SSID</label
            ><span id="cur_ssid" style="font-weight: bold"></span>
          </div>
          <div class="row">
            <label>IP</label><span id="cur_ip" style="font-weight: bold"></span>
          </div>
          <div class="row"><label>RSSI</label><span id="cur_rssi"></span></div>
          <div class="row">
            <label>Link</label
            ><a
              id="cur_link"
              href=""
              target="_blank"
              style="color: #007bff; font-weight: bold; word-break: break-all"
            ></a>
          </div>
        </div>
        <div class="section">
          <h3>
            Telegram
            <label style="font-size: 12px; float: right"
              >Activate <input type="checkbox" id="tg_en"
            /></label>
          </h3>
          <div class="row">
            <label>Bot Token</label
            ><input
              id="tg_token"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div id="ids-container"></div>
          <button
            class="btn"
            style="background: #28a745; margin-bottom: 10px; padding: 8px"
            onclick="addUserId()"
          >
            + Add UserID
          </button>
        </div>
        <div class="section">
          <h3>
            MQTT
            <label style="font-size: 12px; float: right"
              >Activate <input type="checkbox" id="mqtt_en"
            /></label>
          </h3>
          <div class="row">
            <label>Broker IP</label
            ><input
              id="m_ip"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Port</label><input id="m_port" type="number" />
          </div>
          <div class="row">
            <label>User</label
            ><input
              id="m_u"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Pass</label>
            <div class="pass-wrapper">
              <input id="m_p" type="password" /><span
                class="toggle-eye"
                onclick="togglePass('m_p')"
                >üëÅÔ∏è</span
              >
            </div>
          </div>
          <div class="row">
            <label>Topic</label
            ><input
              id="m_t"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Interval (s)</label><input id="m_i" type="number" />
          </div>
        </div>
        <div class="section">
          <h3>Web Security</h3>
          <div class="row">
            <label>Login</label
            ><input
              id="w_u"
              style="
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
          </div>
          <div class="row">
            <label>Password</label>
            <div class="pass-wrapper">
              <input id="w_p" type="password" /><span
                class="toggle-eye"
                onclick="togglePass('w_p')"
                >üëÅÔ∏è</span
              >
            </div>
          </div>
        </div>
        <button class="btn" onclick="saveSrv()">Save settings</button>
      </div>
    </div>
    <script>
      const BASE_URL = "http://192.168.18.76";
      let activeIds = 0;
      const senNames = [
        "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤–æ–∑–¥—É—Ö (DHT22)",
        "–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (5516)",
        "–ù–∞—Ä—É–∂–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (TCRT5000)",
        "–î–≤–∏–∂–µ–Ω–∏–µ (SR501)",
        "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ (LD2420)",
        "–ù–∞—Ä—É–∂–Ω—ã–π –≤–æ–∑–¥—É—Ö (BME280)",
        "–ù–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–±–æ—Ä (DS18B20)",
        "–î–≤–µ—Ä—å (Magnet)",
        "–ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ (Resistor)",
        "–†–µ–ª–µ (Block Rele)",
      ];

      const SENSOR_MAP = {
        bme280_out: {
          title: "–ù–∞—Ä—É–∂–Ω—ã–π –≤–æ–∑–¥—É—Ö (BME280)",
          cards: ["card-out-t", "card-out-h"],
          gpio: 1,
        },
        tcrt5000: {
          title: "–ù–∞—Ä—É–∂–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (TCRT5000)",
          cards: ["card-lux-out"],
          gpio: 1,
        },
        dht22: {
          title: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤–æ–∑–¥—É—Ö (DHT22)",
          cards: ["card-in-t", "card-in-h"],
          gpio: 1,
        },
        lux5516: {
          title: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (5516)",
          cards: ["card-lux"],
          gpio: 1,
        },
        pir: {
          title: "–î–≤–∏–∂–µ–Ω–∏–µ (SR501)",
          cards: ["card-pir"],
          gpio: 1,
        },
        presence: {
          title: "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ (LD2420)",
          cards: ["card-pres"],
          gpio: 1,
        },
        ds18b20: {
          title: "–ù–∞–≥—Ä–µ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–±–æ—Ä (DS18B20)",
          cards: ["card-t1", "card-t2", "card-t3", "card-t4"],
          gpio: 1,
          onewire: true,
        },
        door: {
          title: "–î–≤–µ—Ä—å (Magnet)",
          cards: ["card-door"],
          gpio: 1,
        },
        flood: {
          title: "–ó–∞—Ç–æ–ø–ª–µ–Ω–∏–µ (Resistor)",
          cards: ["card-flood"],
          gpio: 1,
        },
        relay: {
          title: "–†–µ–ª–µ (Block Rele)",
          cards: ["card-r0", "card-r1", "card-r2", "card-r3"],
          gpio: 4,
        },
      };
      async function scanDS() {
        const pin = document.getElementById("sen_g6").value;
        const btn = document.querySelector(".btn-search");
        btn.innerText = "–ü–æ–∏—Å–∫...";
        try {
          const res = await fetch(`${BASE_URL}/api/ds-scan?pin=${pin}`);
          const found = await res.json();
          const listDiv = document.getElementById("ds-found-list");
          listDiv.innerHTML = "";
          found.forEach((item, i) => {
            listDiv.innerHTML += `
                  <div class="ds-item" data-mac="${item.m}">
                      <span>‚Ññ${i + 1} (${item.m}) <span class="ds-temp">[ ${
              item.t
            } ¬∞C ]</span></span>
                      <input type="number" class="ds-u-idx" value="${i + 1}">
                  </div>`;
          });
        } catch (e) {
          alert("Scanning error");
        } finally {
          btn.innerText = "Scan";
        }
      }
      function buildSensorsMenu() {
        const acc = document.getElementById("sensor-accordion");
        acc.innerHTML = "";

        Object.entries(SENSOR_MAP).forEach(([id, s]) => {
          const details = document.createElement("details");

          const summary = document.createElement("summary");
          summary.innerHTML = `
          <input type="checkbox" onchange="toggleSensor('${id}', this.checked)">
          <span style="margin-left:8px">${s.title}</span>
        `;

          const content = document.createElement("div");
          content.className = "details-content";

          // GPIO inputs
          for (let i = 0; i < s.gpio; i++) {
            content.innerHTML += `
            <div class="row">
              <label>GPIO ${i + 1}</label>
              <input type="number" min="0" max="39" id="${id}_gpio_${i}">
            </div>
          `;
          }

          // DS18B20 special block
          if (s.onewire) {
            content.innerHTML += `
            <button class="btn" onclick="scanDS('${id}')">Scan</button>
            <div id="${id}_list"></div>
          `;
          }

          details.appendChild(summary);
          details.appendChild(content);
          acc.appendChild(details);
        });
      }
      function toggleSensor(sensorId, state) {
        SENSOR_MAP[sensorId].cards.forEach((cardId) => {
          const el = document.getElementById(cardId);
          if (el) el.style.display = state ? "block" : "none";
        });
      }
      function renderAccordion(cfg) {
        const container = document.getElementById("sensor-accordion");
        container.innerHTML = "";
        senNames.forEach((name, i) => {
          const isRelay = i === 9;
          const isDS = i === 6;
          let html = `<details>
              <summary><span style="flex:1">${name}</span>
                  <label class="switch" onclick="event.stopPropagation()">
                      <input type="checkbox" id="en${i}" ${
            (isRelay ? cfg.r_en : cfg.sen[i]) ? "checked" : ""
          }>
                      <span class="slider"></span>
                  </label>
              </summary>
              <div class="details-content">`;

          if (isRelay) {
            for (let r = 0; r < 4; r++)
              html += `<div class="row"><label>GPIO –†–µ–ª–µ ${
                r + 1
              }</label><input type="number" id="rel_g${r}" value="${
                cfg.rel_g[r]
              }"></div>`;
          } else if (isDS) {
            html += `<div class="row"><label>GPIO –ü–∏–Ω (–®–∏–Ω–∞ OneWire)</label><input type="number" id="sen_g6" value="${cfg.sen_g[6]}"></div>`;
            html += `<button class="btn btn-search" onclick="scanDS()" style="background:#17a2b8">Search</button>`;
            html += `<div id="ds-found-list">`;
            cfg.ds_l.forEach((item) => {
              html += `<div class="ds-item" data-mac="${item.m}"><span>Sensor <b>(${item.m})</b></span><input type="number" class="ds-u-idx" value="${item.i}"></div>`;
            });
            html += `</div>`;
          } else if (i !== 2 && i !== 5) {
            html += `<div class="row"><label>GPIO –ü–∏–Ω</label><input type="number" id="sen_g${i}" value="${cfg.sen_g[i]}"></div>`;
          } else {
            html += `<div style="color:#999; font-size:12px">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</div>`;
          }
          html += `</div></details>`;
          container.innerHTML += html;
        });
      }
      async function scan(type) {
        const res = document.getElementById("res_" + type);
        if (res) res.innerHTML = "–û–ø—Ä–æ—Å —à–∏–Ω—ã...";
        const pin = document.getElementById("p_ds")?.value || 0;
        const r = await fetch(`${BASE_URL}/api/scan?type=${type}&pin=${pin}`);
        const d = await r.json();
        if (type === "ds18b20" && res) {
          res.innerHTML = "";
          d.forEach((s, i) => {
            res.innerHTML += `<div class="row" style="font-size:12px"><span>#${
              i + 1
            } ${s.mac} | <b>${s.val}¬∞C</b></span> <input type="number" value="${
              i + 1
            }" style="width:40px"></div>`;
          });
        }
      }
      function openTab(e, n) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document.getElementById(n).classList.add("active");
        e.currentTarget.classList.add("active");
      }
      function toggleSets() {
        const p = document.getElementById("settings-panel");
        p.style.display = p.style.display === "block" ? "none" : "block";
      }
      function toggleAcc(el) {
        el.parentElement.nextElementSibling.classList.toggle("show");
      }
      function togglePass(id) {
        const el = document.getElementById(id);
        el.type = el.type === "password" ? "text" : "password";
      }
      const chBox = document.getElementById("checks");
      senNames.forEach((n, i) => {
        chBox.innerHTML += `<label style="display:block; margin:8px 0; font-size:13px"><input type="checkbox" id="ch${i}"> ${n}</label>`;
      });
      function addUserId(val = "") {
        if (activeIds >= 6) return;
        const container = document.getElementById("ids-container");
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<label>UserID ${
          activeIds + 1
        }</label><input id="id${activeIds}" value="${val}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px;">`;
        container.appendChild(div);
        activeIds++;
      }
      function applyVis(senArray, relEn) {
        const maps = [
          ["card-in-t", "card-in-h"],
          ["card-lux"],
          ["card-lux-out"],
          ["card-pir"],
          ["card-pres"],
          ["card-out-t", "card-out-h"],
          ["card-t1", "card-t2"],
          ["card-door"],
          ["card-flood"],
        ];
        senArray.forEach((en, i) => {
          if (maps[i])
            maps[i].forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.style.display = en ? "block" : "none";
            });
        });
        for (let i = 0; i < 4; i++) {
          const el = document.getElementById("card-r" + i);
          if (el) el.style.display = relEn ? "block" : "none";
        }
      }
      function scanWiFi() {
        const n = document.getElementById("nets");
        n.innerHTML = '<div style="padding:10px">üîé Scanning...</div>';
        fetch(`${BASE_URL}/api/scan`)
          .then((r) => r.json())
          .then((d) => {
            n.innerHTML = "";
            d.sort((a, b) => b.rssi - a.rssi);
            d.forEach((x) => {
              const i = document.createElement("div");
              i.className = "net-item";
              let sig = x.rssi > -60 ? "üü¢" : x.rssi > -75 ? "üü°" : "üî¥";
              let lock = x.enc ? "üîí" : "üîì";
              i.innerHTML = `<span>${sig} ${lock} <b>${x.ssid}</b></span> <span style="color:#888">${x.rssi} dBm</span>`;
              i.onclick = () => {
                document.getElementById("ssid").value = x.ssid;
              };
              n.appendChild(i);
            });
          })
          .catch((e) => {
            n.innerHTML =
              '<div style="padding:10px; color:red">Scanning error</div>';
          });
      }
      function pollWifiStatus() {
        fetch(`${BASE_URL}/api/wifi-status`)
          .then((r) => r.json())
          .then((d) => {
            if (d.connected) {
              document.getElementById("curr-conn").style.display = "block";
              document.getElementById("cur_ssid").innerText = d.ssid;
              document.getElementById("cur_ip").innerText = d.ip;
              document.getElementById("cur_rssi").innerText = d.rssi + " dBm";
              const url = "http://" + d.ip + "/";
              const link = document.getElementById("cur_link");
              link.href = url;
              link.innerText = url;
              fetch(`${BASE_URL}/api/ap-disable`);
            } else {
              setTimeout(pollWifiStatus, 3000);
            }
          });
      }
      fetch(`${BASE_URL}/api/get-all`)
        .then((r) => r.json())
        .then((c) => {
          document.getElementById("relays_en").checked = c.r_en;
          document.getElementById("tg_en").checked = c.tg_en;
          document.getElementById("tg_token").value = c.tg;
          document.getElementById("mqtt_en").checked = c.m_en;
          document.getElementById("m_ip").value = c.m_ip;
          document.getElementById("m_port").value = c.m_port;
          document.getElementById("m_u").value = c.m_u;
          document.getElementById("m_p").value = c.m_p;
          document.getElementById("m_t").value = c.m_t;
          document.getElementById("m_i").value = c.m_i;
          document.getElementById("w_u").value = c.w_u;
          document.getElementById("w_p").value = c.w_p;
          for (let i = 0; i < c.ids_c; i++) addUserId(c.ids[i]);
          if (activeIds === 0) addUserId("");
          for (let i = 0; i < 9; i++) {
            if (document.getElementById("ch" + i))
              document.getElementById("ch" + i).checked = c.sen[i];
          }
          applyVis(c.sen, c.r_en);
          pollWifiStatus();
        });
      setInterval(() => {
        fetch(`${BASE_URL}/api/get-relays`)
          .then((r) => r.json())
          .then((d) => {
            d.r.forEach(
              (v, i) => (document.getElementById("r" + i).checked = v)
            );
          });
      }, 1000);
      setInterval(() => {
        fetch(`${BASE_URL}/api/values`)
          .then((r) => r.json())
          .then((v) => {
            [
              "in_t",
              "in_h",
              "out_t",
              "out_h",
              "lux",
              "lux_out",
              "t1",
              "t2",
            ].forEach((f) => {
              if (document.getElementById("v_" + f))
                document.getElementById("v_" + f).innerText = v[f];
            });
            const updateStatus = (id, val, tT, tF) => {
              const el = document.getElementById(id);
              if (!el) return;
              el.innerText = val ? tT : tF;
              el.style.color = val ? "red" : "#007bff";
            };
            updateStatus("v_pir", v.pir, "–ï–°–¢–¨", "–ù–ï–¢");
            updateStatus("v_pres", v.pres, "–ï–°–¢–¨", "–ù–ï–¢");
            updateStatus("v_door", v.door, "–û–¢–ö–†", "–ó–ê–ö–†");
            updateStatus("v_flood", v.flood, "–ï–°–¢–¨", "–ù–ï–¢");
          });
      }, 2000);
      function setRelay(idx) {
        const st = document.getElementById("r" + idx).checked;
        fetch(`/api/set-relay?id=${idx}&st=${st}`);
      }
      function conn() {
        const f = new FormData();
        f.append("s", document.getElementById("ssid").value);
        f.append("p", document.getElementById("w_pass").value);
        fetch(`${BASE_URL}/api/wifi-connect`, { method: "POST", body: f }).then(
          () => {
            alert("Connection...");
            pollWifiStatus();
          }
        );
      }
      function saveSrv() {
        const f = new FormData();
        f.append("tg_en", document.getElementById("tg_en").checked);
        f.append("tg", document.getElementById("tg_token").value);
        f.append("ids_c", activeIds);
        for (let i = 0; i < activeIds; i++)
          f.append("id" + i, document.getElementById("id" + i).value);
        f.append("m_en", document.getElementById("mqtt_en").checked);
        f.append("m_ip", document.getElementById("m_ip").value);
        f.append("m_port", document.getElementById("m_port").value);
        f.append("m_u", document.getElementById("m_u").value);
        f.append("m_p", document.getElementById("m_p").value);
        f.append("m_t", document.getElementById("m_t").value);
        f.append("m_i", document.getElementById("m_i").value);
        f.append("w_u", document.getElementById("w_u").value);
        f.append("w_p", document.getElementById("w_p").value);
        fetch(`${BASE_URL}/api/save-srv`, { method: "POST", body: f }).then(
          () => alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        );
      }
      function saveChecks() {
        const f = new FormData();
        const sens = [];
        const rEn = document.getElementById("relays_en").checked;
        f.append("r_en", rEn);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö 9 —Ç–∏–ø–æ–≤ –¥–∞—Ç—á–∏–∫–æ–≤
        for (let i = 0; i < 9; i++) {
          const en = document.getElementById("ch" + i).checked;
          f.append("ch" + i, en);
          sens.push(en);
        }

        // === –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø DS18B20 ===
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–∞—Ö –Ω–∞ —à–∏–Ω–µ
        const dsItems = document.querySelectorAll(".ds-item");
        dsItems.forEach((el, idx) => {
          f.append(`dsm${idx}`, el.dataset.mac); // MAC-–∞–¥—Ä–µ—Å –¥–∞—Ç—á–∏–∫–∞
          f.append(`dsi${idx}`, el.querySelector(".ds-u-idx").value); // –ò–Ω–¥–µ–∫—Å, –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        });
        f.append("dsc", dsItems.length); // –ü–µ—Ä–µ–¥–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
        // =============================

        applyVis(sens, rEn);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ESP32
        fetch(`${BASE_URL}/api/save-sen`, { method: "POST", body: f }).then(
          () => alert("–ü—Ä–∏–º–µ–Ω–µ–Ω–æ")
        );
      }
    </script>
  </body>
</html>
